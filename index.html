<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0d0c08">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Circles">
  <link rel="manifest" href="circles.webmanifest">
  <title>Circles â€” Your World, Mapped</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --bg: #0d0c08;
      --tb-bg: rgba(13, 12, 8, .92);
      --bar-bg: rgba(13, 12, 8, .96);
      --surface-a: rgba(26, 24, 18, .92);
      --surface: #1a1812;
      --border: #2e2b20;
      --gold: #c8963e;
      --gold-lt: #e8b85a;
      --gold-dim: rgba(200, 150, 62, .15);
      --cream: #f5eedc;
      --paper: #faf6ec;
      --ink: #1e1a0f;
      --ink-soft: #4a4232;
      --ink-faint: #8a7d60;
      --red: #c0392b;
      --teal: #16a085;
      --cw: 200px;
      --ch: 138px;
      --r: 10px;
      --sh: 0 4px 24px rgba(0, 0, 0, .18), 0 1px 4px rgba(0, 0, 0, .1);
      --sh2: 0 8px 40px rgba(0, 0, 0, .28), 0 2px 8px rgba(0, 0, 0, .14);
    }

    [data-theme="light"] {
      --bg: #f4efe2;
      --tb-bg: rgba(244, 239, 226, .95);
      --bar-bg: rgba(244, 239, 226, .98);
      --surface-a: rgba(255, 252, 245, .97);
      --surface: #fffcf5;
      --border: #d8cead;
      --gold: #a0722e;
      --gold-lt: #c08a3a;
      --gold-dim: rgba(160, 114, 46, .12);
      --cream: #1e1a0f;
      --paper: #ffffff;
      --ink: #1e1a0f;
      --ink-soft: #4a4232;
      --ink-faint: #7a6e52;
      --sh: 0 4px 24px rgba(0, 0, 0, .08), 0 1px 4px rgba(0, 0, 0, .05);
      --sh2: 0 8px 40px rgba(0, 0, 0, .12), 0 2px 8px rgba(0, 0, 0, .07);
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--cream);
      font-family: 'Lato', sans-serif
    }

    /* TOPBAR */
    #tb {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      background: var(--tb-bg);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border)
    }

    #logo {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0
    }

    #lt {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--gold)
    }

    #ls {
      font-size: 10px;
      color: var(--ink-faint);
      letter-spacing: .12em;
      text-transform: uppercase
    }

    #sw {
      flex: 1;
      max-width: 340px;
      position: relative;
      margin: 0 auto
    }

    #s {
      width: 100%;
      padding: 8px 14px 8px 36px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--cream);
      font-family: 'Lato', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color .2s
    }

    #s::placeholder {
      color: var(--ink-faint)
    }

    #s:focus {
      border-color: var(--gold)
    }

    #si {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ink-faint);
      font-size: 14px;
      pointer-events: none
    }

    #sr {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      display: none;
      z-index: 200
    }

    #sr.open {
      display: block
    }

    .sri {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      transition: background .15s
    }

    .sri:last-child {
      border-bottom: none
    }

    .sri:hover {
      background: var(--gold-dim)
    }

    .sri strong {
      color: var(--gold-lt)
    }

    #tba {
      display: flex;
      gap: 8px;
      flex-shrink: 0
    }

    .tbb {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .05em;
      cursor: pointer;
      border: 1px solid;
      transition: all .2s;
      text-transform: uppercase;
      background: transparent;
      border-color: var(--border);
      color: var(--ink-faint)
    }

    .tbb:hover {
      border-color: var(--gold);
      color: var(--gold)
    }

    /* MOBILE MENU */
    #mbtn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--ink-faint);
      font-size: 20px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all .2s;
      line-height: 1
    }

    #mbtn:hover,
    #mbtn.open {
      border-color: var(--gold);
      color: var(--gold)
    }

    #mdd {
      position: fixed;
      top: 60px;
      right: 12px;
      z-index: 300;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--sh2);
      min-width: 180px;
      overflow: hidden;
      display: none;
      flex-direction: column;
      animation: mi .15s ease
    }

    #mdd.open {
      display: flex
    }

    .mdi {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 18px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .04em;
      color: var(--ink-faint);
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      transition: background .15s;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border)
    }

    .mdi:last-child {
      border-bottom: none
    }

    .mdi:hover {
      background: var(--gold-dim);
      color: var(--gold)
    }

    .mdi-icon {
      font-size: 16px
    }

    @media(max-width:600px) {
      #tba {
        display: none
      }

      #sw {
        display: none
      }

      #mbtn {
        display: flex
      }

      #mdd {
        width: calc(100% - 24px);
        right: 12px;
        left: 12px;
      }

      #mdd .msw {
        display: block;
        padding: 12px 18px;
        border-bottom: 1px solid var(--border);
      }

      #mdd .msw #s2 {
        width: 100%;
        padding: 10px 14px 10px 38px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--cream);
        font-family: 'Lato', sans-serif;
        font-size: 14px;
        outline: none;
      }

      #mdd .msw #s2:focus {
        border-color: var(--gold);
      }

      #mdd .msw-wrap {
        position: relative;
      }

      #mdd .msw-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--ink-faint);
        font-size: 16px;
        pointer-events: none;
      }

      #logo #ls {
        display: none
      }

      #lt {
        font-size: 17px
      }

      #tb {
        justify-content: space-between;
      }
    }

    /* CANVAS */
    #cw {
      position: fixed;
      inset: 56px 0 0 0;
      overflow: hidden;
      cursor: grab;
      background-color: var(--bg);
      background-image: radial-gradient(ellipse at 20% 30%, rgba(200, 150, 62, .06) 0%, transparent 60%), radial-gradient(ellipse at 80% 70%, rgba(100, 80, 30, .08) 0%, transparent 60%)
    }

    #cw.pan {
      cursor: grabbing
    }

    #svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible
    }

    .cp {
      fill: none;
      stroke: #8a7040;
      stroke-width: 2;
      stroke-opacity: .6
    }

    .cp.hl {
      stroke: var(--gold);
      stroke-opacity: .95;
      stroke-width: 2.5
    }

    .sp {
      fill: none;
      stroke: var(--teal);
      stroke-width: 2;
      stroke-dasharray: 6, 4;
      stroke-opacity: .75
    }

    .sp.hl {
      stroke: var(--teal);
      stroke-opacity: 1;
      stroke-width: 2.5
    }

    .sb {
      fill: none;
      stroke: #8a60c0;
      stroke-width: 1.5;
      stroke-dasharray: 3, 5;
      stroke-opacity: .65
    }

    .sb.hl {
      stroke: #a87de0;
      stroke-opacity: 1;
      stroke-width: 2
    }

    #nw {
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      transform-origin: 0 0
    }

    /* NODES */
    .no {
      position: absolute;
      width: var(--cw);
      transform: translate(-50%, -50%);
      user-select: none
    }

    .ar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 4px
    }

    .ab {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px dashed var(--gold);
      background: rgba(200, 150, 62, .12);
      color: var(--gold);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      opacity: 0;
      pointer-events: none
    }

    .ab:hover {
      background: var(--gold);
      color: #1a1200;
      border-style: solid;
      transform: scale(1.12)
    }

    .asib {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px dashed #8a60c0;
      background: rgba(138, 96, 192, .12);
      color: #8a60c0;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      opacity: 0;
      pointer-events: none
    }

    .asib:hover {
      background: #8a60c0;
      color: #fff;
      border-style: solid;
      transform: scale(1.12)
    }

    .as {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px dashed var(--teal);
      background: rgba(22, 160, 133, .12);
      color: var(--teal);
      font-size: 13px;
      cursor: pointer;
      transition: all .2s;
      opacity: 0;
      pointer-events: none
    }

    .as:hover {
      background: var(--teal);
      color: #fff;
      border-style: solid;
      transform: scale(1.12)
    }

    .abc {
      margin-top: 4px
    }

    .no.sel .ab,
    .no:hover .ab,
    .no.sel .as,
    .no:hover .as,
    .no.sel .asib,
    .no:hover .asib {
      opacity: 1;
      pointer-events: all
    }

    .nc {
      width: var(--cw);
      height: var(--ch);
      background: var(--paper);
      border-radius: var(--r);
      box-shadow: var(--sh);
      border: 1.5px solid #ddd5c0;
      padding: 12px;
      position: relative;
      cursor: pointer;
      transition: box-shadow .2s, border-color .2s;
      overflow: hidden
    }

    .nc::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--gold-lt));
      border-radius: var(--r) var(--r) 0 0;
      opacity: 0;
      transition: opacity .2s
    }

    .no.sel .nc,
    .nc:hover {
      box-shadow: var(--sh2);
      border-color: var(--gold)
    }

    .no.sel .nc::before,
    .nc:hover::before {
      opacity: 1
    }

    .nc.rc {
      border-color: var(--gold);
      background: #fffbf0
    }

    .nc.rc::before {
      opacity: 1
    }

    .nc.dm {
      opacity: .3
    }

    .nc.sc {
      border-color: rgba(22, 160, 133, .5)
    }

    .nc.sc::before {
      background: linear-gradient(90deg, var(--teal), #1abc9c);
      opacity: 1
    }

    .av {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 15px;
      font-weight: 700;
      color: #fff
    }

    .av.m {
      background: linear-gradient(135deg, #4a7fb5, #2c5f8a)
    }

    .av.f {
      background: linear-gradient(135deg, #c0607a, #8a3050)
    }

    .av.u {
      background: linear-gradient(135deg, #7a7060, #554c3a)
    }

    .nb {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--gold-dim);
      color: var(--gold);
      border: 1px solid rgba(200, 150, 62, .3);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 6px;
      max-width: 130px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .nn {
      font-family: 'Playfair Display', serif;
      font-size: 13.5px;
      font-weight: 600;
      color: var(--ink);
      line-height: 1.25;
      max-width: 130px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-bottom: 2px
    }

    .nk {
      font-size: 11px;
      color: var(--ink-soft);
      font-style: italic;
      margin-bottom: 4px
    }

    .nd {
      font-size: 10.5px;
      color: var(--ink-faint);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 130px
    }

    .na {
      position: absolute;
      bottom: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity .2s
    }

    .nc:hover .na,
    .no.sel .na {
      opacity: 1
    }

    .nab {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: all .15s
    }

    .ned {
      background: rgba(200, 150, 62, .15);
      color: var(--gold)
    }

    .ned:hover {
      background: var(--gold);
      color: #1a1200
    }

    .ndl {
      background: rgba(192, 57, 43, .12);
      color: var(--red)
    }

    .ndl:hover {
      background: var(--red);
      color: #fff
    }

    .dt {
      position: absolute;
      left: 50%;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gold);
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity .2s;
      pointer-events: none
    }

    .dtt {
      top: -4px
    }

    .dtb {
      bottom: -4px
    }

    .nc:hover .dt,
    .no.sel .dt {
      opacity: 1
    }

    /* CONTROLS - bottom LEFT (FIX #1, #3) */
    #cc {
      position: fixed;
      bottom: 24px;
      left: 24px;
      z-index: 90;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start
    }

    #rv {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--cream);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--sh);
      transition: all .2s;
      letter-spacing: .02em
    }

    #rv:hover {
      border-color: var(--gold);
      color: var(--gold)
    }

    #zc {
      display: flex;
      gap: 6px
    }

    .zb {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--ink-faint);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      font-weight: 300;
      box-shadow: var(--sh)
    }

    .zb:hover {
      border-color: var(--gold);
      color: var(--gold)
    }

    /* MODAL */
    #mo {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, .65);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #mo.open {
      display: flex
    }

    #md {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 460px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .2s ease
    }

    @keyframes mi {
      from {
        opacity: 0;
        transform: translateY(16px) scale(.97)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    #mh {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    #mt {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      color: var(--gold)
    }

    #mc {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      transition: color .15s
    }

    #mc:hover {
      color: var(--cream)
    }

    #mb {
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      max-height: 60vh;
      overflow-y: auto
    }

    #mb .full {
      grid-column: 1/-1
    }

    .fl label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--ink-faint);
      margin-bottom: 6px
    }

    .fl input,
    .fl select,
    .fl textarea {
      width: 100%;
      padding: 9px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--cream);
      font-family: 'Lato', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color .2s
    }

    .fl input:focus,
    .fl select:focus,
    .fl textarea:focus {
      border-color: var(--gold)
    }

    .fl select option {
      background: var(--bg)
    }

    .fl textarea {
      resize: vertical;
      min-height: 60px
    }

    #mf {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end
    }

    .mb {
      padding: 9px 22px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid;
      transition: all .2s
    }

    .mbc {
      background: transparent;
      border-color: var(--border);
      color: var(--ink-faint)
    }

    .mbc:hover {
      border-color: var(--cream);
      color: var(--cream)
    }

    .mbs {
      background: var(--gold);
      border-color: var(--gold);
      color: #1a1200
    }

    .mbs:hover {
      background: var(--gold-lt)
    }

    /* CONFIRM DIALOG (FIX #2) */
    #co {
      position: fixed;
      inset: 0;
      z-index: 300;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #co.open {
      display: flex
    }

    #cb {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      width: 380px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .18s ease;
      padding: 28px 28px 22px;
      text-align: center
    }

    #ci {
      font-size: 36px;
      margin-bottom: 12px
    }

    #ctit {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--cream);
      margin-bottom: 8px
    }

    #cmsg {
      font-size: 13px;
      color: var(--ink-faint);
      line-height: 1.5;
      margin-bottom: 24px
    }

    #cact {
      display: flex;
      gap: 10px;
      justify-content: center
    }

    #cno {
      padding: 9px 22px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--ink-faint);
      transition: all .2s
    }

    #cno:hover {
      border-color: var(--cream);
      color: var(--cream)
    }

    #cyes {
      padding: 9px 22px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid var(--red);
      background: rgba(192, 57, 43, .15);
      color: var(--red);
      transition: all .2s
    }

    #cyes:hover {
      background: var(--red);
      color: #fff
    }

    /* PANEL (FIX #3: z-index 95 > controls 90) */
    #pn {
      position: fixed;
      top: 56px;
      right: 0;
      bottom: 0;
      width: 300px;
      z-index: 95;
      background: var(--surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform .28s cubic-bezier(.4, 0, .2, 1);
      overflow-y: auto;
      display: flex;
      flex-direction: column
    }

    #pn.open {
      transform: none
    }

    #ph {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px
    }

    #pa {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: #fff
    }

    #pa.m {
      background: linear-gradient(135deg, #4a7fb5, #2c5f8a)
    }

    #pa.f {
      background: linear-gradient(135deg, #c0607a, #8a3050)
    }

    #pa.u {
      background: linear-gradient(135deg, #7a7060, #554c3a)
    }

    #ptit {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--cream);
      margin-bottom: 4px
    }

    #pnk {
      font-size: 13px;
      color: var(--ink-faint);
      font-style: italic;
      margin-bottom: 6px
    }

    #pbg {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 10px;
      background: var(--gold-dim);
      color: var(--gold);
      border: 1px solid rgba(200, 150, 62, .3);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase
    }

    #pc {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      flex-shrink: 0;
      transition: color .15s
    }

    #pc:hover {
      color: var(--cream)
    }

    #pb {
      padding: 20px;
      flex: 1
    }

    .pr {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: flex-start
    }

    .pri {
      font-size: 16px;
      margin-top: 1px;
      flex-shrink: 0
    }

    .prl {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--ink-faint);
      margin-bottom: 2px
    }

    .prv {
      font-size: 13px;
      color: var(--cream);
      word-break: break-word
    }

    .pre {
      color: var(--ink-faint);
      font-style: italic
    }

    #pac {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px
    }

    .pab {
      flex: 1;
      padding: 9px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid;
      text-align: center;
      transition: all .2s;
      letter-spacing: .04em
    }

    .pae {
      background: var(--gold-dim);
      border-color: rgba(200, 150, 62, .3);
      color: var(--gold)
    }

    .pae:hover {
      background: var(--gold);
      color: #1a1200;
      border-color: var(--gold)
    }

    .pad {
      background: rgba(192, 57, 43, .1);
      border-color: rgba(192, 57, 43, .25);
      color: var(--red)
    }

    .pad:hover {
      background: var(--red);
      color: #fff;
      border-color: var(--red)
    }

    /* TOAST */
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      z-index: 400;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 13px;
      color: var(--cream);
      opacity: 0;
      transition: all .3s;
      pointer-events: none;
      white-space: nowrap
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0)
    }

    /* WELCOME MODAL */
    #wm {
      position: fixed;
      inset: 0;
      z-index: 500;
      background: rgba(0, 0, 0, .75);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #wm.open {
      display: flex
    }

    #wb {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 480px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .25s ease;
      overflow: hidden
    }

    #wt {
      padding: 28px 28px 0;
      text-align: center
    }

    #wi {
      font-size: 40px;
      margin-bottom: 12px
    }

    #wtt {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 6px
    }

    #ws {
      font-size: 13px;
      color: var(--ink-faint);
      line-height: 1.6
    }

    #wg {
      padding: 20px 28px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 4px
    }

    .wgi {
      background: rgba(200, 150, 62, .07);
      border: 1px solid rgba(200, 150, 62, .18);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      gap: 10px;
      align-items: flex-start
    }

    .wgic {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 1px
    }

    .wgit {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 3px
    }

    .wgid {
      font-size: 12px;
      color: var(--ink-faint);
      line-height: 1.45
    }

    #wf {
      padding: 20px 28px 24px;
      text-align: center;
      border-top: 1px solid var(--border)
    }

    #wok {
      padding: 11px 36px;
      border-radius: 10px;
      background: var(--gold);
      border: none;
      color: #1a1200;
      font-family: 'Lato', sans-serif;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      letter-spacing: .04em
    }

    #wok:hover {
      background: var(--gold-lt);
      transform: translateY(-1px)
    }

    /* LINK EXISTING PICKER */
    #lx {
      position: fixed;
      inset: 0;
      z-index: 250;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #lx.open {
      display: flex
    }

    #lxb {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 420px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .2s ease;
      overflow: hidden
    }

    #lxh {
      padding: 18px 22px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    #lxt {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--gold)
    }

    #lxc {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
      transition: color .15s
    }

    #lxc:hover {
      color: var(--cream)
    }

    #lxs {
      padding: 12px 22px;
      border-bottom: 1px solid var(--border)
    }

    #lxsi {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--cream);
      font-family: 'Lato', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color .2s
    }

    #lxsi:focus {
      border-color: var(--gold)
    }

    #lxl {
      max-height: 280px;
      overflow-y: auto
    }

    .lxi {
      padding: 10px 22px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background .15s;
      display: flex;
      align-items: center;
      gap: 12px
    }

    .lxi:last-child {
      border-bottom: none
    }

    .lxi:hover {
      background: var(--gold-dim)
    }

    .lxiav {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0
    }

    .lxin {
      font-size: 13px;
      color: var(--cream)
    }

    .lxis {
      font-size: 11px;
      color: var(--ink-faint)
    }

    #lxne {
      padding: 14px 22px;
      border-top: 1px solid var(--border);
      text-align: center
    }

    .lxneb {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 18px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      background: var(--gold-dim);
      color: var(--gold);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      letter-spacing: .04em
    }

    .lxneb:hover {
      background: var(--gold);
      color: #1a1200
    }

    /* LEGEND purple for siblings */
    .lr-sib {
      color: #8a60c0
    }

    #leg {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 89;
      background: var(--surface-a);
      padding: 10px 14px;
      font-size: 11px;
      color: var(--ink-faint);
      line-height: 2
    }

    .lr {
      display: flex;
      align-items: center;
      gap: 8px
    }

    ::-webkit-scrollbar {
      width: 6px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px
    }

    /* â”€â”€ MODE SWITCHER â”€â”€ */
    #modeBar {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      z-index: 99;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      background: var(--bar-bg);
      border-bottom: 1px solid var(--border);
      height: 44px;
    }

    .modeTab {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 0 28px;
      height: 100%;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .07em;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--ink-faint);
      border: none;
      background: transparent;
      border-bottom: 2px solid transparent;
      transition: color .2s, border-color .2s;
    }

    .modeTab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }

    .modeTab:hover:not(.active) {
      color: var(--cream);
    }

    /* adjust existing canvas top offset for mode bar */
    #cw {
      top: 100px;
    }

    #cc {
      bottom: 18px;
    }

    #leg {
      bottom: 18px;
    }

    /* â”€â”€ CIRCLES CANVAS â”€â”€ */
    #circlesCanvas {
      display: none;
      position: fixed;
      inset: 100px 0 0 0;
      overflow: hidden;
      background: radial-gradient(ellipse at 50% 40%, rgba(74, 127, 181, .08) 0%, transparent 65%),
        radial-gradient(ellipse at 20% 80%, rgba(200, 150, 62, .05) 0%, transparent 60%),
        var(--bg);
      cursor: grab;
    }

    #circlesCanvas.pan {
      cursor: grabbing;
    }

    #circlesCanvas.active {
      display: block;
    }

    #circlesSvg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
    }

    #circlesWorld {
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      transform-origin: 0 0;
    }

    /* USER NODE */
    .c-user {
      position: absolute;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(135deg, #c8963e, #e8b85a);
      border: 3px solid var(--gold-lt);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #1a1200;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 11px;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 32px rgba(200, 150, 62, .4), 0 4px 16px rgba(0, 0, 0, .4);
      cursor: default;
      user-select: none;
      z-index: 5;
    }

    .c-user-emoji {
      font-size: 24px;
      line-height: 1;
    }

    .c-user-label {
      font-size: 9px;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* GROUP BUBBLE (Level 2) */
    .c-group {
      position: absolute;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 2px solid;
      cursor: pointer;
      user-select: none;
      transition: transform .2s, box-shadow .2s;
      z-index: 4;
    }

    .c-group:hover {
      transform: translate(-50%, -50%) scale(1.08);
    }

    .c-group.expanded {
      border-style: solid;
    }

    .c-group-emoji {
      font-size: 26px;
      line-height: 1;
    }

    .c-group-name {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
      margin-top: 4px;
      text-align: center;
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 4px;
    }

    .c-group-count {
      font-size: 8px;
      font-weight: 700;
      padding: 1px 5px;
      border-radius: 8px;
      margin-top: 2px;
    }

    /* SUB-GROUP BUBBLE (Level 3) */
    .c-subgroup {
      position: absolute;
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      width: 68px;
      height: 68px;
      border-radius: 50%;
      border: 1.5px solid rgba(200, 150, 62, .4);
      background: var(--surface-a);
      z-index: 3;
      backdrop-filter: blur(8px);
    }

    .c-subgroup.visible {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .c-subgroup:hover {
      border-color: var(--gold);
      box-shadow: 0 0 14px rgba(200, 150, 62, .25);
    }

    .c-subgroup-label {
      font-size: 8.5px;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
      color: var(--cream);
      text-align: center;
      padding: 0 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 60px;
    }

    .c-subgroup-count {
      font-size: 8px;
      color: var(--gold);
      margin-top: 2px;
    }

    /* SVG connector lines for circles canvas */
    .c-line {
      stroke: rgba(200, 150, 62, .25);
      stroke-width: 1.5;
      fill: none;
    }

    .c-line-sub {
      stroke: rgba(200, 150, 62, .15);
      stroke-width: 1;
      fill: none;
      stroke-dasharray: 4, 4;
    }

    /* ADD GROUP BUTTON */
    #addGroupBtn {
      position: fixed;
      bottom: 80px;
      right: 24px;
      z-index: 92;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--gold);
      color: #1a1200;
      font-size: 26px;
      font-weight: 300;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(200, 150, 62, .45);
      display: none;
      align-items: center;
      justify-content: center;
      transition: transform .2s, box-shadow .2s;
    }

    #addGroupBtn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 28px rgba(200, 150, 62, .6);
    }

    #addGroupBtn.active {
      display: flex;
    }

    /* â”€â”€ GROUP CONTEXT MENU â”€â”€ */
    #groupCtxMenu {
      position: fixed;
      z-index: 500;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--sh2);
      min-width: 160px;
      overflow: hidden;
      display: none;
    }

    #groupCtxMenu.open {
      display: block;
    }

    .ctx-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 16px;
      font-size: 13px;
      font-weight: 700;
      color: var(--ink-faint);
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      transition: background .15s;
      border-bottom: 1px solid var(--border);
    }

    .ctx-item:last-child {
      border-bottom: none;
    }

    .ctx-item:hover {
      background: var(--gold-dim);
      color: var(--gold);
    }

    .ctx-item.danger:hover {
      background: rgba(192, 57, 43, .12);
      color: var(--red);
    }

    /* â”€â”€ CREATE / EDIT GROUP MODAL â”€â”€ */
    #groupMo {
      position: fixed;
      inset: 0;
      z-index: 400;
      background: rgba(0, 0, 0, .65);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
    }

    #groupMo.open {
      display: flex;
    }

    #groupMd {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: var(--sh2);
      width: min(480px, 94vw);
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
    }

    #groupMh {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 0;
      margin-bottom: 16px;
    }

    #groupMh span {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--cream);
    }

    #groupMh button {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
    }

    #groupMb {
      padding: 0 24px 8px;
    }

    #groupMf {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 16px 24px 20px;
    }

    /* group type grid */
    .gtype-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 4px;
    }

    .gtype-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 4px;
      border-radius: 10px;
      border: 1.5px solid var(--border);
      background: transparent;
      color: var(--ink-faint);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .04em;
      cursor: pointer;
      transition: all .2s;
    }

    .gtype-btn .gt-emoji {
      font-size: 20px;
    }

    .gtype-btn.sel,
    .gtype-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: var(--gold-dim);
    }

    /* color palette */
    .gcolor-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gcolor-swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform .15s, border-color .15s;
    }

    .gcolor-swatch.sel,
    .gcolor-swatch:hover {
      transform: scale(1.2);
      border-color: var(--cream);
    }

    /* sub-group tags inside the group modal */
    .gsg-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .gsg-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 20px;
      background: var(--gold-dim);
      border: 1px solid rgba(200, 150, 62, .3);
      color: var(--gold);
      font-size: 12px;
      font-weight: 700;
    }

    .gsg-tag-del {
      background: none;
      border: none;
      color: var(--gold);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      opacity: .7;
    }

    .gsg-tag-del:hover {
      opacity: 1;
    }

    #gsgInput {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--cream);
      font-size: 12px;
      outline: none;
      width: 140px;
      transition: border-color .2s;
    }

    #gsgInput:focus {
      border-color: var(--gold);
    }

    /* â”€â”€ PEOPLE LIST MODAL â”€â”€ */
    #peopleMo {
      position: fixed;
      inset: 0;
      z-index: 400;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    #peopleMo.open {
      display: flex;
    }

    #peopleMd {
      background: var(--surface);
      border-radius: 20px 20px 0 0;
      box-shadow: var(--sh2);
      width: min(600px, 100vw);
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      border-bottom: none;
    }

    #peopleMh {
      padding: 18px 22px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #peopleMh .pm-title {
      flex: 1;
      min-width: 0;
    }

    #peopleMh .pm-grp {
      font-size: 11px;
      color: var(--gold);
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    #peopleMh .pm-sub {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--cream);
    }

    #peopleMh button {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
      flex-shrink: 0;
    }

    #peopleMbody {
      flex: 1;
      overflow-y: auto;
      padding: 12px 0;
    }

    #peopleMfoot {
      padding: 14px 22px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    /* person row in people list */
    .ppl-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 22px;
      transition: background .15s;
      cursor: default;
    }

    .ppl-row:hover {
      background: rgba(200, 150, 62, .06);
    }

    .ppl-av {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 15px;
      color: #fff;
      flex-shrink: 0;
      border: 2px solid transparent;
    }

    .ppl-av.str-close {
      border-color: var(--gold);
      box-shadow: 0 0 8px rgba(200, 150, 62, .3);
    }

    .ppl-av.str-lost {
      opacity: .5;
    }

    .ppl-info {
      flex: 1;
      min-width: 0;
    }

    .ppl-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--cream);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ppl-nick {
      font-size: 12px;
      color: var(--ink-faint);
      font-style: italic;
      margin-bottom: 2px;
    }

    .ppl-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
    }

    .ppl-badge.close {
      background: rgba(200, 150, 62, .15);
      color: var(--gold);
    }

    .ppl-badge.friend {
      background: rgba(22, 160, 133, .12);
      color: var(--teal);
    }

    .ppl-badge.acquaintance {
      background: rgba(138, 125, 96, .12);
      color: var(--ink-faint);
    }

    .ppl-badge.lost {
      background: rgba(192, 57, 43, .1);
      color: rgba(192, 57, 43, .7);
    }

    .ppl-badge.family {
      background: rgba(138, 96, 192, .12);
      color: #8a60c0;
    }

    .ppl-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .ppl-act {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s;
    }

    .ppl-act.edit {
      background: rgba(200, 150, 62, .12);
      color: var(--gold);
    }

    .ppl-act.edit:hover {
      background: var(--gold);
      color: #1a1200;
    }

    .ppl-act.del {
      background: rgba(192, 57, 43, .1);
      color: var(--red);
    }

    .ppl-act.del:hover {
      background: var(--red);
      color: #fff;
    }

    .ppl-empty {
      padding: 40px 22px;
      text-align: center;
      color: var(--ink-faint);
      font-size: 13px;
    }

    /* Add/Edit person in circles â€” inline form inside people modal */
    #circlePersonForm {
      display: none;
      background: var(--bg);
      border-top: 1px solid var(--border);
      padding: 18px 22px;
    }

    #circlePersonForm.open {
      display: block;
    }

    #circlePersonForm .cpf-title {
      font-family: 'Playfair Display', serif;
      font-size: 15px;
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 14px;
    }

    .str-radio-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .str-radio {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      color: var(--ink-faint);
      transition: all .2s;
      user-select: none;
    }

    .str-radio input {
      display: none;
    }

    .str-radio.sel,
    .str-radio:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: var(--gold-dim);
    }

    /* link-from-family search */
    #linkFamSearch {
      display: none;
      border-top: 1px solid var(--border);
      padding: 14px 22px;
    }

    #linkFamSearch.open {
      display: block;
    }

    #linkFamSearch input {
      width: 100%;
      padding: 9px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--cream);
      font-size: 13px;
      outline: none;
      transition: border-color .2s;
    }

    #linkFamSearch input:focus {
      border-color: var(--gold);
    }

    #linkFamResults {
      margin-top: 8px;
    }

    .lfr-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background .15s;
    }

    .lfr-item:hover {
      background: var(--gold-dim);
    }

    .lfr-av {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 13px;
      color: #fff;
      flex-shrink: 0;
    }

    .lfr-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--cream);
    }

    .lfr-sub {
      font-size: 11px;
      color: var(--ink-faint);
    }

    /* Circles zoom controls (reuse existing .zb) */
    #circlesCC {
      position: fixed;
      bottom: 18px;
      left: 24px;
      z-index: 90;
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    #crv {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--cream);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--sh);
      transition: all .2s;
      letter-spacing: .02em;
      font-family: 'Lato', sans-serif;
    }

    #crv:hover {
      border-color: var(--gold);
      color: var(--gold)
    }

    #circlesCC.active {
      display: flex;
    }

    /* responsive */
    @media(max-width:600px) {
      .modeTab {
        padding: 0 16px;
        font-size: 11px;
      }

      .gtype-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      #peopleMd {
        max-height: 92vh;
        border-radius: 16px 16px 0 0;
      }
    }
  </style>
</head>

<body>
  <header id="tb">
    <div id="logo"><span style="font-size:22px">&#127795;</span>
      <div>
        <div id="lt">Circles</div>
        <div id="ls">Your World, Mapped</div>
      </div>
    </div>
    <div id="sw"><span id="si">&#128269;</span><input id="s" type="text" placeholder="Search..." autocomplete="off">
      <div id="sr"></div>
    </div>
    <div id="tba">
      <button class="tbb" id="thmBtn" title="Toggle light/dark mode">ðŸŒ™</button>
      <button class="tbb" id="hlp">&#10067; Help</button>
      <label class="tbb" style="cursor:pointer">&#11014; Import<input type="file" id="imp" accept=".json"
          style="display:none"></label>
      <button class="tbb" id="exp">&#11015; Export</button>
    </div>
    <!-- Mobile hamburger -->
    <button id="mbtn" title="Menu">&#8942;</button>
  </header>

  <!-- MODE SWITCHER -->
  <div id="modeBar">
    <button class="modeTab active" id="tabFamily">ðŸŒ³ Family Tree</button>
    <button class="modeTab" id="tabCircles">ðŸ”µ Circles</button>
  </div>

  <!-- Mobile dropdown menu -->
  <div id="mdd">
    <div class="msw">
      <div class="msw-wrap">
        <span class="msw-icon">&#128269;</span>
        <input id="s2" type="text" placeholder="Search..." autocomplete="off">
      </div>
    </div>
    <button class="mdi" id="mthmBtn"><span class="mdi-icon">ðŸŒ™</span> Toggle Theme</button>
    <button class="mdi" id="mhlp"><span class="mdi-icon">&#10067;</span> Help</button>
    <label class="mdi" style="cursor:pointer"><span class="mdi-icon">&#11014;</span> Import<input type="file" id="mimp"
        accept=".json" style="display:none"></label>
    <button class="mdi" id="mexp"><span class="mdi-icon">&#11015;</span> Export</button>
  </div>

  <div id="cw">
    <svg id="svg">
      <g id="sg"></g>
    </svg>
    <div id="nw"></div>
    <div id="eh" style="display:none"></div>
  </div>

  <!-- CIRCLES CANVAS -->
  <div id="circlesCanvas">
    <svg id="circlesSvg">
      <g id="csg"></g>
    </svg>
    <div id="circlesWorld"></div>
  </div>

  <!-- ADD GROUP FAB -->
  <button id="addGroupBtn" title="Add Group">ï¼‹</button>

  <!-- GROUP CONTEXT MENU -->
  <div id="groupCtxMenu">
    <button class="ctx-item" id="ctxEditGroup">âœï¸ Edit Group</button>
    <button class="ctx-item" id="ctxAddSub">ï¼‹ Add Sub-group</button>
    <button class="ctx-item danger" id="ctxDelGroup">ðŸ—‘ Delete Group</button>
  </div>

  <!-- CREATE / EDIT GROUP MODAL -->
  <div id="groupMo">
    <div id="groupMd">
      <div id="groupMh"><span id="groupMtitle">New Group</span><button id="groupMclose">&times;</button></div>
      <div id="groupMb">
        <!-- Type selector -->
        <div class="fl full" style="margin-bottom:14px">
          <label style="display:block;margin-bottom:8px">Group Type</label>
          <div class="gtype-grid">
            <button class="gtype-btn sel" data-type="school" data-emoji="ðŸ«" data-color="#4a7fb5"
              data-subs="Friends,Teachers,Classmates"><span class="gt-emoji">ðŸ«</span>School</button>
            <button class="gtype-btn" data-type="university" data-emoji="ðŸŽ“" data-color="#16a085"
              data-subs="Friends,Lecturers,Classmates"><span class="gt-emoji">ðŸŽ“</span>Uni</button>
            <button class="gtype-btn" data-type="work" data-emoji="ðŸ’¼" data-color="#8a60c0"
              data-subs="Team,Clients,Management"><span class="gt-emoji">ðŸ’¼</span>Work</button>
            <button class="gtype-btn" data-type="neighbourhood" data-emoji="ðŸ˜ï¸" data-color="#c8963e"
              data-subs="Neighbours,Friends"><span class="gt-emoji">ðŸ˜ï¸</span>Hood</button>
            <button class="gtype-btn" data-type="community" data-emoji="ðŸ•Œ" data-color="#c0392b"
              data-subs="Members,Leaders"><span class="gt-emoji">ðŸ•Œ</span>Community</button>
            <button class="gtype-btn" data-type="sports" data-emoji="âš½" data-color="#27ae60"
              data-subs="Teammates,Coaches"><span class="gt-emoji">âš½</span>Sports</button>
            <button class="gtype-btn" data-type="online" data-emoji="ðŸ’»" data-color="#2980b9"
              data-subs="Friends,Mutuals"><span class="gt-emoji">ðŸ’»</span>Online</button>
            <button class="gtype-btn" data-type="custom" data-emoji="âœï¸" data-color="#7f8c8d" data-subs=""><span
                class="gt-emoji">âœï¸</span>Custom</button>
          </div>
        </div>
        <div class="fl full"><label>Group Name *</label><input id="gname" type="text" placeholder="e.g. SMK Alam Shah">
        </div>
        <div style="display:flex;gap:12px">
          <div class="fl" style="flex:1"><label>Emoji</label><input id="gemoji" type="text" placeholder="ðŸ«"
              style="width:80px"></div>
          <div class="fl" style="flex:1"><label>Year Start</label><input id="gyearS" type="number" placeholder="2010"
              min="1900" max="2100"></div>
          <div class="fl" style="flex:1"><label>Year End</label><input id="gyearE" type="number" placeholder="2015"
              min="1900" max="2100"></div>
        </div>
        <div class="fl full" style="margin-bottom:4px"><label>Colour</label>
          <div class="gcolor-row" id="gcolorRow">
            <div class="gcolor-swatch sel" data-color="#4a7fb5" style="background:#4a7fb5"></div>
            <div class="gcolor-swatch" data-color="#16a085" style="background:#16a085"></div>
            <div class="gcolor-swatch" data-color="#8a60c0" style="background:#8a60c0"></div>
            <div class="gcolor-swatch" data-color="#c8963e" style="background:#c8963e"></div>
            <div class="gcolor-swatch" data-color="#c0392b" style="background:#c0392b"></div>
            <div class="gcolor-swatch" data-color="#27ae60" style="background:#27ae60"></div>
          </div>
        </div>
        <div class="fl full">
          <label>Sub-groups</label>
          <div class="gsg-list" id="gsgList"></div>
          <input id="gsgInput" type="text" placeholder="Add sub-group + Enter">
        </div>
      </div>
      <div id="groupMf">
        <button class="mb mbc" id="groupMcancel">Cancel</button>
        <button class="mb mbs" id="groupMsave">Save Group</button>
      </div>
    </div>
  </div>

  <!-- PEOPLE LIST MODAL (bottom sheet) -->
  <div id="peopleMo">
    <div id="peopleMd">
      <div id="peopleMh">
        <div class="pm-title">
          <div class="pm-grp" id="pmGroupLabel"></div>
          <div class="pm-sub" id="pmSubLabel"></div>
        </div>
        <button id="peopleMclose">&times;</button>
      </div>
      <div id="peopleMbody">
        <div id="pplList"></div>
        <!-- Inline Add/Edit Person Form -->
        <div id="circlePersonForm">
          <div class="cpf-title" id="cpfTitle">Add Person</div>
          <div class="fl full"><label>Full Name *</label><input id="cpfName" type="text" placeholder="e.g. Ahmad Farid">
          </div>
          <div style="display:flex;gap:12px">
            <div class="fl" style="flex:1"><label>Nickname</label><input id="cpfNick" type="text"
                placeholder="e.g. Farid"></div>
            <div class="fl" style="flex:1"><label>Gender</label>
              <select id="cpfGender">
                <option value="unknown">--</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>
          </div>
          <div class="fl full"><label>Phone</label><input id="cpfPhone" type="tel" placeholder="+60123456789"></div>
          <div class="fl full"><label>How We Met</label><input id="cpfMet" type="text"
              placeholder="e.g. UITM orientation, Sept 2019"></div>
          <div class="fl full"><label>Met On (Date)</label><input id="cpfMetOn" type="date"></div>
          <div class="fl full">
            <label>Relationship</label>
            <div class="str-radio-row" id="strRadioRow">
              <label class="str-radio sel" data-val="close_friend"><input type="radio" name="str" value="close_friend"
                  checked>â­ Close Friend</label>
              <label class="str-radio" data-val="friend"><input type="radio" name="str" value="friend">ðŸ‘‹ Friend</label>
              <label class="str-radio" data-val="acquaintance"><input type="radio" name="str" value="acquaintance">ðŸ¤
                Acquaintance</label>
              <label class="str-radio" data-val="lost_touch"><input type="radio" name="str" value="lost_touch">ðŸŒ« Lost
                Touch</label>
            </div>
          </div>
          <div class="fl full"><label>ðŸ”’ Private Note <span style="font-size:10px;color:var(--ink-faint)">(not
                exported)</span></label><textarea id="cpfNote"
              placeholder="e.g. allergic to seafood, owes me RM50 lol..." rows="2"></textarea></div>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
            <button class="mb mbc" id="cpfCancel">Cancel</button>
            <button class="mb mbs" id="cpfSave">Save Person</button>
          </div>
        </div>
        <!-- Link from Family Tree -->
        <div id="linkFamSearch">
          <div
            style="font-size:12px;font-weight:700;color:var(--gold);margin-bottom:8px;letter-spacing:.06em;text-transform:uppercase">
            Link from Family Tree</div>
          <input id="linkFamInput" type="text" placeholder="Search family members...">
          <div id="linkFamResults"></div>
        </div>
      </div>
      <div id="peopleMfoot">
        <button class="mb mbs" id="btnAddPerson" style="flex:1">ï¼‹ Add Person</button>
        <button class="mb" id="btnLinkFam"
          style="flex:1;background:rgba(138,96,192,.15);border-color:#8a60c0;color:#a87de0">ðŸ”— Link from Family</button>
      </div>
    </div>
  </div>

  <!-- CIRCLES ZOOM CONTROLS -->
  <div id="circlesCC">
    <button id="crv">&#8984; Centre View</button>
    <div id="czc" style="display:flex;gap:6px"><button class="zb" id="czi">+</button><button class="zb"
        id="czo">&minus;</button></div>
  </div>

  <!-- WELCOME MODAL -->
  <div id="wm">
    <div id="wb">
      <div id="wt">
        <div id="wi">ðŸŒ¿</div>
        <div id="wtt">Welcome to Circles</div>
        <div id="ws">Map your world â€” family roots, old friends, and every circle that shaped you. Private, offline, and
          always yours.</div>
      </div>
      <div id="wg">
        <div class="wgi">
          <div class="wgic">ðŸŒ³</div>
          <div>
            <div class="wgit">Family Tree</div>
            <div class="wgid">Add parents, children, spouses &amp; siblings. The tree auto-lays out â€” no dragging
              needed.</div>
          </div>
        </div>
        <div class="wgi">
          <div class="wgic">ðŸ”µ</div>
          <div>
            <div class="wgit">Circles</div>
            <div class="wgid">Group people by life chapter â€” school, work, neighbourhood, and more. Drag bubbles to
              arrange.</div>
          </div>
        </div>
        <div class="wgi">
          <div class="wgic">ðŸ‘†</div>
          <div>
            <div class="wgit">Select &amp; Inspect</div>
            <div class="wgid">Click any card to select it; double-click (or double-tap) to open the detail panel.</div>
          </div>
        </div>
        <div class="wgi">
          <div class="wgic">âž•</div>
          <div>
            <div class="wgit">Add Relatives</div>
            <div class="wgid">Hover a family card â€” use <strong style="color:var(--gold)">+</strong> buttons to add
              parents or children.</div>
          </div>
        </div>
        <div class="wgi">
          <div class="wgic">ðŸ”—</div>
          <div>
            <div class="wgit">Link Existing</div>
            <div class="wgid">Pick an existing person from the tree instead of creating a duplicate.</div>
          </div>
        </div>
        <div class="wgi">
          <div class="wgic">âŠ•</div>
          <div>
            <div class="wgit">Centre View</div>
            <div class="wgid">Use the Centre View button (bottom-left) to reset the canvas pan &amp; zoom at any time.
            </div>
          </div>
        </div>
      </div>
      <div id="wf"><button id="wok">Get Started â†’</button></div>
    </div>
  </div>

  <div id="cc">
    <button id="rv">&#8984; Centre View</button>
    <div id="zc"><button class="zb" id="zi">+</button><button class="zb" id="zo">&minus;</button></div>
  </div>

  <div id="leg">
    <div class="lr"><span
        style="display:inline-block;width:20px;height:2px;background:var(--gold);border-radius:1px"></span> Parent /
      Child</div>
    <div class="lr"><span style="display:inline-block;width:20px;border-top:2px dashed var(--teal)"></span> Spouse /
      Partner</div>
    <div class="lr"><span style="display:inline-block;width:20px;border-top:2px dotted #8a60c0"></span> Siblings</div>
  </div>

  <!-- FORM MODAL -->
  <div id="mo">
    <div id="md">
      <div id="mh"><span id="mt">Add Person</span><button id="mc">&times;</button></div>
      <div id="mb">
        <div class="fl full"><label>Full Name *</label><input id="fn" type="text" placeholder="e.g. Ahmad bin Abdullah">
        </div>
        <div class="fl"><label>Nickname (Panggilan)</label><input id="fk" type="text" placeholder="e.g. Pak Long"></div>
        <div class="fl"><label>Gender</label><select id="fg">
            <option value="unknown">-- Select --</option>
            <option value="male">Male (Lelaki)</option>
            <option value="female">Female (Perempuan)</option>
          </select></div>
        <div class="fl full"><label>Relationship Label</label>
          <select id="fl">
            <option value="">-- Select --</option>
            <optgroup label="Direct">
              <option>Ayah / Bapa</option>
              <option>Ibu / Mama</option>
              <option>Abang</option>
              <option>Kakak</option>
              <option>Adik</option>
              <option>Anak</option>
              <option>Menantu</option>
            </optgroup>
            <optgroup label="Grandparents">
              <option>Tok Ayah (Datuk)</option>
              <option>Tok (Nenek)</option>
              <option>Tok Ayah sebelah Ibu</option>
              <option>Tok sebelah Ibu</option>
            </optgroup>
            <optgroup label="Extended - Paternal">
              <option>Pak Long</option>
              <option>Pak Ngah</option>
              <option>Pak Teh</option>
              <option>Pak Cik</option>
              <option>Pak Su</option>
            </optgroup>
            <optgroup label="Extended - Maternal">
              <option>Mak Long</option>
              <option>Mak Ngah</option>
              <option>Mak Teh</option>
              <option>Mak Cik</option>
              <option>Mak Su</option>
            </optgroup>
            <optgroup label="Cousins &amp; Descendants">
              <option>Sepupu (1st)</option>
              <option>Sepupu (2nd)</option>
              <option>Sepupu Jauh</option>
              <option>Cucu</option>
              <option>Cicit</option>
            </optgroup>
            <option value="__c">Edit Custom Label...</option>
          </select>
          <input id="flc" type="text" placeholder="Type custom label..." style="margin-top:6px;display:none">
        </div>
        <div class="fl"><label>Phone Number</label><input id="fp" type="tel" placeholder="+60123456789"></div>
        <div class="fl full"><label>Address</label><textarea id="fa"
            placeholder="e.g. No. 12, Jalan Mawar, Selangor"></textarea></div>
      </div>
      <div id="mf"><button class="mb mbc" id="mca">Cancel</button><button class="mb mbs" id="msv">Save</button></div>
    </div>
  </div>

  <!-- CONFIRM DIALOG FIX #2 -->
  <div id="co">
    <div id="cb">
      <div id="ci">&#128465;</div>
      <div id="ctit">Remove this person?</div>
      <div id="cmsg">This will remove them and their connections from the tree.</div>
      <div id="cact"><button id="cno">Cancel</button><button id="cyes">Yes, Remove</button></div>
    </div>
  </div>

  <!-- SIDE PANEL -->
  <div id="pn">
    <div id="ph">
      <div id="pa" class="u">?</div>
      <div style="flex:1;min-width:0">
        <div id="ptit">--</div>
        <div id="pnk"></div>
        <div id="pbg"></div>
      </div>
      <button id="pc">&times;</button>
    </div>
    <div id="pb">
      <div class="pr"><span class="pri">&#128222;</span>
        <div>
          <div class="prl">Phone</div>
          <div id="pph" class="prv pre">--</div>
        </div>
      </div>
      <div class="pr"><span class="pri">&#128205;</span>
        <div>
          <div class="prl">Address</div>
          <div id="pad2" class="prv pre">--</div>
        </div>
      </div>
      <div class="pr"><span class="pri">&#128141;</span>
        <div>
          <div class="prl">Spouse / Partner</div>
          <div id="psp" class="prv pre">--</div>
        </div>
      </div>
      <div class="pr"><span class="pri">&#128106;</span>
        <div>
          <div class="prl">Parents</div>
          <div id="ppar" class="prv pre">--</div>
        </div>
      </div>
      <div class="pr"><span class="pri">&#128118;</span>
        <div>
          <div class="prl">Children</div>
          <div id="pch" class="prv pre">--</div>
        </div>
      </div>
    </div>
    <div id="pac"><button class="pab pae" id="ped">Edit</button><button class="pab pad" id="pdl">Delete</button></div>
  </div>

  <!-- LINK EXISTING PICKER -->
  <div id="lx">
    <div id="lxb">
      <div id="lxh"><span id="lxt">Link Existing Person</span><button id="lxc">&times;</button></div>
      <div id="lxs"><input id="lxsi" type="text" placeholder="Search by name..." autocomplete="off"></div>
      <div id="lxl"></div>
      <div id="lxne"><button class="lxneb" id="lxnew">+ Create New Person Instead</button></div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    const S = { nodes: {}, rootId: null, selId: null, tf: { x: 0, y: 0, sc: 1 }, modal: null, drag: null, pan: false, po: null, confirmCb: null, lastTouchId: null }
    const uid = () => {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
      const c = window.crypto || window.msCrypto;
      if (c && c.getRandomValues) {
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, ch =>
          (ch ^ c.getRandomValues(new Uint8Array(1))[0] & 15 >> ch / 4).toString(16)
        );
      }
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, ch => {
        const r = Math.random() * 16 | 0, v = ch == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };
    const $ = id => document.getElementById(id)

    const mdd = $('mdd'), mbtn = $('mbtn')
    const tabFamily = $('tabFamily'), tabCircles = $('tabCircles')
    const circlesCanvas = $('circlesCanvas')
    const addGroupBtn = $('addGroupBtn')
    const circlesCC = $('circlesCC')
    const cWorld = $('circlesWorld')
    const cSvgG = $('csg')
    const groupCtxMenu = $('groupCtxMenu')
    const CW = 200, CH = 138, GY = 220, GX = 240

    function ini(n) { if (!n) return '?'; return n.trim().split(/\s+/).slice(0, 2).map(w => w[0].toUpperCase()).join('') }

    // CONFIRM FIX #2
    function confirm2(title, msg, cb) { $('ctit').textContent = title; $('cmsg').textContent = msg; S.confirmCb = cb; $('co').classList.add('open') }
    $('cno').addEventListener('click', () => { $('co').classList.remove('open'); S.confirmCb = null })
    $('cyes').addEventListener('click', () => { $('co').classList.remove('open'); if (S.confirmCb) { S.confirmCb(); S.confirmCb = null } })

    // STORAGE
    function save() { try { localStorage.setItem('sl_v1', JSON.stringify({ nodes: S.nodes, rootId: S.rootId })) } catch (e) { toast('Storage full! Export your data.') } }
    function load() { try { const r = localStorage.getItem('sl_v1'); if (!r) return false; const d = JSON.parse(r); S.nodes = d.nodes || {}; S.rootId = d.rootId || null; return true } catch (e) { return false } }

    // NODES
    function mkNode(d) { return { id: uid(), fullName: d.fullName || '', nickname: d.nickname || '', label: d.label || '', gender: d.gender || 'unknown', phone: d.phone || '', address: d.address || '', parentIds: [], childrenIds: [], spouseId: null, siblingIds: [], isRoot: d.isRoot || false, x: d.x ?? 0, y: d.y ?? 0 } }
    function ensureSibArr(n) { if (!Array.isArray(n.siblingIds)) n.siblingIds = [] }
    function initRoot() { const r = mkNode({ fullName: 'You', isRoot: true, x: 0, y: 0 }); S.nodes[r.id] = r; S.rootId = r.id; save() }
    function reposChildren(p) { const ids = p.childrenIds; if (!ids.length) return; const tw = (ids.length - 1) * GX; ids.forEach((cid, i) => { if (S.nodes[cid]) S.nodes[cid].x = p.x - tw / 2 + i * GX }) }

    // â”€â”€ AUTO-LAYOUT: assigns clean positions to every node in the family tree â”€â”€
    function layoutTree() {
      const nodes = S.nodes
      const keys = Object.keys(nodes)
      if (!keys.length) return

      // BFS from root (or first node) to assign generation rows
      const startId = S.rootId || keys[0]
      const gen = {}   // nodeId â†’ integer row (0=root, +1=children, -1=parents)
      const queue = [[startId, 0]]
      while (queue.length) {
        const [nid, g] = queue.shift()
        if (gen[nid] !== undefined) continue
        gen[nid] = g
        const n = nodes[nid]; if (!n) continue
          ; (n.parentIds || []).forEach(pid => { if (gen[pid] === undefined) queue.push([pid, g - 1]) })
          ; (n.childrenIds || []).forEach(cid => { if (gen[cid] === undefined) queue.push([cid, g + 1]) })
        if (n.spouseId && gen[n.spouseId] === undefined) queue.push([n.spouseId, g])
          ; (n.siblingIds || []).forEach(sid => { if (gen[sid] === undefined) queue.push([sid, g]) })
      }
      // Include any disconnected nodes
      keys.forEach(id => { if (gen[id] === undefined) gen[id] = 0 })

      // Group ids by generation
      const byGen = {}
      Object.entries(gen).forEach(([id, g]) => { if (!byGen[g]) byGen[g] = []; byGen[g].push(id) })

      // Within each generation, try to order nodes so spouses are adjacent and
      // children roughly centre under their parents. Simple heuristic: sort by
      // average x of parents (fall back to sibling order).
      // We do two passes so parent positions are established before child ordering.
      const HGAP = CW + 60   // 260 px horizontal gap between card centres
      const VGAP = GY        // 220 px vertical gap between generations

      // First pass: assign naive positions top-to-bottom
      const genNums = Object.keys(byGen).map(Number).sort((a, b) => a - b)
      genNums.forEach(g => {
        const ids = byGen[g]
        // Sort: spouses adjacent to each other, siblings together
        // Simple sort: put spouses next to each other
        const ordered = sortGeneration(ids, nodes)
        const total = ordered.length
        ordered.forEach((id, i) => {
          if (!nodes[id]) return
          nodes[id].x = (i - (total - 1) / 2) * HGAP
          nodes[id].y = g * VGAP
        })
      })

      // Second pass (single): nudge children to centre under their parent group
      genNums.filter(g => g > Math.min(...genNums)).forEach(g => {
        const ids = byGen[g]
        const parentGroups = {}
        ids.forEach(id => {
          const n = nodes[id]; if (!n) return
          const parentKey = [...(n.parentIds || [])].sort().join('|') || '__none'
          if (!parentGroups[parentKey]) parentGroups[parentKey] = { ids: [], parentIds: n.parentIds || [] }
          parentGroups[parentKey].ids.push(id)
        })
        Object.values(parentGroups).forEach(({ ids: gids, parentIds: pids }) => {
          if (!pids.length) return
          const parentCx = pids.reduce((s, pid) => s + (nodes[pid] ? nodes[pid].x : 0), 0) / pids.length
          const groupW = (gids.length - 1) * HGAP
          gids.forEach((id, i) => {
            if (nodes[id]) nodes[id].x = parentCx - groupW / 2 + i * HGAP
          })
        })
      })
    }

    function sortGeneration(ids, nodes) {
      // Group spouses together; otherwise keep original order
      const placed = new Set()
      const result = []
      ids.forEach(id => {
        if (placed.has(id)) return
        result.push(id); placed.add(id)
        const sp = nodes[id]?.spouseId
        if (sp && ids.includes(sp) && !placed.has(sp)) { result.push(sp); placed.add(sp) }
      })
      return result
    }

    // ADD/EDIT/DELETE
    function addNode(fromId, type, fd) {
      const from = S.nodes[fromId]; if (!from) return
      let x, y
      if (type === 'parent') { x = from.x + (from.parentIds.length === 1 ? GX / 2 : 0); y = from.y - GY; if (from.parentIds.length === 1) { const ex = S.nodes[from.parentIds[0]]; if (ex) ex.x = from.x - GX / 2 } }
      else if (type === 'spouse') { x = from.x + CW + 80; y = from.y }
      else { const idx = from.childrenIds.length, tw = idx * GX; x = from.x - tw / 2 + idx * GX; y = from.y + GY }
      const node = mkNode({ ...fd, x, y }); S.nodes[node.id] = node
      if (type === 'parent') { from.parentIds.push(node.id); node.childrenIds.push(fromId) }
      else if (type === 'spouse') { from.spouseId = node.id; node.spouseId = fromId }
      else {
        from.childrenIds.push(node.id); node.parentIds.push(fromId)
        // FIX #4: link child to spouse as well
        if (from.spouseId && S.nodes[from.spouseId]) { const sp = S.nodes[from.spouseId]; if (!sp.childrenIds.includes(node.id)) { sp.childrenIds.push(node.id); node.parentIds.push(from.spouseId) } }
        reposChildren(from)
      }
      save(); layoutTree(); render(); selNode(node.id); toast('Added ' + (node.fullName || 'person'))
    }
    function editNode(id, fd) { if (!S.nodes[id]) return; const n = S.nodes[id]; n.fullName = fd.fullName; n.nickname = fd.nickname; n.label = fd.label; n.gender = fd.gender; n.phone = fd.phone; n.address = fd.address; save(); render(); if (S.selId === id) updPanel(id); toast('Changes saved') }
    function delNode(id) {
      const n = S.nodes[id]; if (!n) return
      n.parentIds.forEach(pid => { if (S.nodes[pid]) S.nodes[pid].childrenIds = S.nodes[pid].childrenIds.filter(x => x !== id) })
      n.childrenIds.forEach(cid => { if (S.nodes[cid]) S.nodes[cid].parentIds = S.nodes[cid].parentIds.filter(x => x !== id) })
      if (n.spouseId && S.nodes[n.spouseId]) S.nodes[n.spouseId].spouseId = null
      if (Array.isArray(n.siblingIds)) n.siblingIds.forEach(sid => { const s = S.nodes[sid]; if (s && Array.isArray(s.siblingIds)) s.siblingIds = s.siblingIds.filter(x => x !== id) })
      if (id === S.rootId) { const rem = Object.keys(S.nodes).filter(k => k !== id); S.rootId = rem[0] || null; if (S.rootId) S.nodes[S.rootId].isRoot = true }
      delete S.nodes[id]
      if (S.selId === id) { S.selId = null; closePanel() }
      save(); layoutTree(); render(); toast('Person removed')
    }

    // RENDER
    const sg = $('sg'), nw = $('nw')
    function applyTf() { const { x, y, sc } = S.tf; nw.style.transform = `translate(${x}px,${y}px) scale(${sc})`; nw.style.transformOrigin = '0 0'; sg.setAttribute('transform', `translate(${x},${y}) scale(${sc})`) }
    function render() { renderConns(); renderNodes(); $('eh').style.display = Object.keys(S.nodes).length <= 1 ? 'block' : 'none' }

    function mkPath(d, cls) { const p = document.createElementNS('http://www.w3.org/2000/svg', 'path'); p.setAttribute('d', d); p.setAttribute('class', cls); sg.appendChild(p); return p }
    function mkLine(x1, y1, x2, y2, cls) { const l = document.createElementNS('http://www.w3.org/2000/svg', 'line'); l.setAttribute('x1', x1); l.setAttribute('y1', y1); l.setAttribute('x2', x2); l.setAttribute('y2', y2); l.setAttribute('class', cls); sg.appendChild(l); return l }

    function renderConns() {
      sg.innerHTML = ''
      const q = $('s').value.trim().toLowerCase()
      const hl = n => !!(q && mn(n, q))

      // â”€â”€ 1. Spouse links (dashed teal horizontal bar between card edges) â”€â”€â”€â”€â”€â”€
      const drawnSpouse = new Set()
      Object.values(S.nodes).forEach(n => {
        if (!n.spouseId || drawnSpouse.has(n.id) || drawnSpouse.has(n.spouseId)) return
        const sp = S.nodes[n.spouseId]; if (!sp) return
        drawnSpouse.add(n.id); drawnSpouse.add(n.spouseId)
        const left = n.x < sp.x ? n : sp, right = n.x < sp.x ? sp : n
        const y = (left.y + right.y) / 2
        const cls = 'sp' + (hl(n) || hl(sp) ? ' hl' : '')
        mkLine(left.x + CW / 2, y, right.x - CW / 2, y, cls)
      })

      // â”€â”€ 2. Family-unit connectors (parent(s) â†’ children) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Group children by their parent-set key so siblings share one connector.
      // Key = sorted parentIds joined by '|'
      const familyGroups = {} // key â†’ {parentIds, childIds}
      Object.values(S.nodes).forEach(child => {
        if (!child.parentIds.length) return
        const key = [...child.parentIds].sort().join('|')
        if (!familyGroups[key]) familyGroups[key] = { parentIds: child.parentIds, childIds: [] }
        familyGroups[key].childIds.push(child.id)
      })

      Object.values(familyGroups).forEach(({ parentIds, childIds }) => {
        const parents = parentIds.map(id => S.nodes[id]).filter(Boolean)
        const children = childIds.map(id => S.nodes[id]).filter(Boolean)
        if (!parents.length || !children.length) return

        const anyHl = parents.some(hl) || children.some(hl)
        const cpCls = 'cp' + (anyHl ? ' hl' : '')

        // Origin point: midpoint between parents (or single parent centre)
        let ox, oy
        if (parents.length === 1) {
          ox = parents[0].x
          oy = parents[0].y + CH / 2
        } else {
          // midpoint of the couple bar (between their card edges)
          const left = parents[0].x < parents[1].x ? parents[0] : parents[1]
          const right = parents[0].x < parents[1].x ? parents[1] : parents[0]
          ox = (left.x + CW / 2 + right.x - CW / 2) / 2
          oy = (left.y + right.y) / 2          // bar is at card mid-height
        }

        // Drop point: vertical stem drops halfway to children row
        const childY = children.reduce((s, c) => s + c.y, 0) / children.length
        const junctionY = oy + (childY - oy) * 0.45  // ~45% of the way down

        // Vertical stem from origin down to junction
        mkLine(ox, oy, ox, junctionY, cpCls)

        if (children.length === 1) {
          // Single child â€” straight line from junction to child top
          const c = children[0]
          mkLine(ox, junctionY, c.x, junctionY, cpCls)
          mkLine(c.x, junctionY, c.x, c.y - CH / 2, cpCls)
        } else {
          // Multiple children â€” horizontal rail at junction, then drop to each
          const xs = children.map(c => c.x)
          const minX = Math.min(...xs), maxX = Math.max(...xs)
          mkLine(minX, junctionY, maxX, junctionY, cpCls)
          children.forEach(c => {
            mkLine(c.x, junctionY, c.x, c.y - CH / 2, cpCls)
          })
        }
      })

      // â”€â”€ 3. Explicit sibling lines (purple dotted, between sibling cards) â”€â”€â”€â”€â”€â”€
      const drawnSib = new Set()
      Object.values(S.nodes).forEach(n => {
        if (!Array.isArray(n.siblingIds)) return
        n.siblingIds.forEach(sid => {
          const pairKey = [n.id, sid].sort().join('|')
          if (drawnSib.has(pairKey)) return
          drawnSib.add(pairKey)
          const sib = S.nodes[sid]; if (!sib) return
          const left = n.x < sib.x ? n : sib, right = n.x < sib.x ? sib : n
          const midY = (left.y + right.y) / 2
          const x1 = left.x + CW / 2, x2 = right.x - CW / 2
          const cls = 'sb' + (hl(n) || hl(sib) ? ' hl' : '')
          mkLine(x1, midY, x2, midY, cls)
        })
      })
    }

    function mn(node, q) { return node.fullName.toLowerCase().includes(q) || node.nickname.toLowerCase().includes(q) || node.label.toLowerCase().includes(q) }

    function renderNodes() {
      const q = $('s').value.trim().toLowerCase()
      const ex = {}; nw.querySelectorAll('.no').forEach(el => { ex[el.dataset.id] = el })
      Object.keys(ex).forEach(id => { if (!S.nodes[id]) ex[id].remove() })
      Object.values(S.nodes).forEach(node => {
        let el = ex[node.id]
        if (!el) { el = buildEl(node); nw.appendChild(el) } else refreshEl(el, node)
        el.style.left = node.x + 'px'; el.style.top = node.y + 'px'
        el.querySelector('.nc').classList.toggle('dm', !!(q && !mn(node, q)))
        el.classList.toggle('sel', node.id === S.selId)
      })
    }

    function buildEl(node) { const el = document.createElement('div'); el.className = 'no'; el.dataset.id = node.id; el.innerHTML = nhtml(node); bindEl(el, node); return el }

    function refreshEl(el, node) {
      const av = el.querySelector('.av'); av.className = 'av ' + (node.gender === 'male' ? 'm' : node.gender === 'female' ? 'f' : 'u'); av.textContent = ini(node.fullName)
      const bg = el.querySelector('.nb'); bg.textContent = node.label || (node.isRoot ? 'You' : ''); bg.style.display = (node.label || node.isRoot) ? 'inline-block' : 'none'
      el.querySelector('.nn').textContent = node.fullName || '(No name)'
      el.querySelector('.nk').textContent = node.nickname ? `"${node.nickname}"` : ''
      el.querySelector('.nd').textContent = node.phone || node.address || ''
      const nc = el.querySelector('.nc'); nc.className = 'nc' + (node.isRoot ? ' rc' : '') + (node.spouseId ? ' sc' : '')
      const sb = el.querySelector('[data-a="spouse"]'); if (sb) sb.style.display = node.spouseId ? 'none' : ''
      const pb = el.querySelector('[data-a="parent"]'); if (pb) { pb.style.opacity = node.parentIds.length >= 2 ? '.3' : ''; pb.style.pointerEvents = node.parentIds.length >= 2 ? 'none' : '' }
      const sib = el.querySelector('[data-a="sibling"]'); if (sib) sib.style.display = node.parentIds.length > 0 ? '' : ' none'
    }

    function nhtml(node) {
      const bl = node.label || (node.isRoot ? 'You' : '')
      const parentMax = node.parentIds.length >= 2
      const sibAvail = node.parentIds.length > 0
      return `<div class="ar">
    <button class="ab" data-a="parent" title="Add Parent" ${parentMax ? 'style="opacity:.3;pointer-events:none"' : ''}>+</button>
    <button class="asib" data-a="sibling" title="Add Sibling" style="${sibAvail ? '' : 'display:none'}">â‡”</button>
    <button class="as" data-a="spouse" title="Add Spouse/Partner" style="${node.spouseId ? 'display:none' : ''}">&#128141;</button>
  </div>
  <div class="nc${node.isRoot ? ' rc' : ''}${node.spouseId ? ' sc' : ''}">
    <div class="dt dtt"></div>
    <div class="av ${node.gender === 'male' ? 'm' : node.gender === 'female' ? 'f' : 'u'}">${ini(node.fullName)}</div>
    <div class="nb" style="${bl ? '' : 'display:none'}">${bl}</div>
    <div class="nn">${node.fullName || '(No name)'}</div>
    <div class="nk">${node.nickname ? `"${node.nickname}"` : ''}  </div>
    <div class="nd">${node.phone || node.address || ''}</div>
    <div class="na">
      <button class="nab ned" title="Edit">&#9998;</button>
      <button class="nab ndl" title="Delete">&#128465;</button>
    </div>
    <div class="dt dtb"></div>
  </div>
  <button class="ab abc" data-a="child" title="Add Child">+</button>`
    }

    function bindEl(el, node) {
      // Family tree nodes are NOT draggable â€” layout is automatic.
      // Clicking/double-clicking selects the node.
      el.querySelector('.nc').addEventListener('click', e => {
        if (e.target.closest('button')) return
        if (S.drag && S.drag.mv) return
        if (S.lastTouchId === node.id) return
        selOnly(node.id)
      })
      el.querySelector('.nc').addEventListener('dblclick', e => {
        e.stopPropagation()
        selNode(node.id)
      })
      el.querySelector('.ned').addEventListener('click', e => { e.stopPropagation(); openModal('edit', node.id) })
      el.querySelector('.ndl').addEventListener('click', e => { e.stopPropagation(); confirm2(`Remove "${node.fullName || 'this person'}"?`, 'This will remove them and their connections. Orphaned members remain.', () => delNode(node.id)) })
      el.querySelector('[data-a="parent"]').addEventListener('click', e => { e.stopPropagation(); if (node.parentIds.length >= 2) { toast('Max 2 parents'); return }; openLinkPicker('parent', node.id) })
      el.querySelector('[data-a="child"]').addEventListener('click', e => { e.stopPropagation(); openLinkPicker('child', node.id) })
      const sib = el.querySelector('[data-a="sibling"]')
      if (sib) sib.addEventListener('click', e => { e.stopPropagation(); openLinkPicker('sibling', node.id) })
      const sb = el.querySelector('[data-a="spouse"]')
      if (sb) sb.addEventListener('click', e => { e.stopPropagation(); if (node.spouseId) { toast('Already has a partner'); return }; openLinkPicker('spouse', node.id) })
    }

    // PAN & ZOOM
    const cvs = $('cw')
    cvs.addEventListener('mousedown', e => { if (e.target.closest('.nc') || e.target.closest('.ab') || e.target.closest('.as')) return; S.pan = true; S.po = { x: e.clientX, y: e.clientY, tx: S.tf.x, ty: S.tf.y }; cvs.classList.add('pan') })
    document.addEventListener('mousemove', e => {
      if (S.drag) { const dx = (e.clientX - S.drag.ox) / S.tf.sc, dy = (e.clientY - S.drag.oy) / S.tf.sc; if (Math.abs(dx) > 3 || Math.abs(dy) > 3) S.drag.mv = true; if (S.drag.mv) { const n = S.nodes[S.drag.id]; if (n) { n.x = S.drag.nx + dx; n.y = S.drag.ny + dy }; renderConns(); const el = nw.querySelector(`[data-id="${S.drag.id}"]`); if (el && S.nodes[S.drag.id]) { el.style.left = S.nodes[S.drag.id].x + 'px'; el.style.top = S.nodes[S.drag.id].y + 'px' } }; return }
      if (S.pan && S.po) { S.tf.x = S.po.tx + (e.clientX - S.po.x); S.tf.y = S.po.ty + (e.clientY - S.po.y); applyTf() }
    })
    document.addEventListener('mouseup', () => { if (S.drag && S.drag.mv) { save(); render() }; S.drag = null; S.pan = false; S.po = null; cvs.classList.remove('pan') })
    cvs.addEventListener('wheel', e => { e.preventDefault(); const f = e.deltaY < 0 ? 1.08 : .93, r = cvs.getBoundingClientRect(), mx = e.clientX - r.left, my = e.clientY - r.top; S.tf.x = mx + (S.tf.x - mx) * f; S.tf.y = my + (S.tf.y - my) * f; S.tf.sc = Math.max(.15, Math.min(3, S.tf.sc * f)); applyTf() }, { passive: false })

    // TOUCH SUPPORT
    let T = { touches: [], pinchDist: null, panStart: null, tfStart: null, dragNode: null, dragStart: null, lastTap: null }
    function tdist(a, b) { return Math.hypot(a.clientX - b.clientX, a.clientY - b.clientY) }
    function tmid(a, b, r) { return { x: (a.clientX + b.clientX) / 2 - r.left, y: (a.clientY + b.clientY) / 2 - r.top } }

    cvs.addEventListener('touchstart', e => {
      T.touches = [...e.touches]
      if (e.touches.length === 1) {
        const t = e.touches[0]
        const el = document.elementFromPoint(t.clientX, t.clientY)
        if (el && el.closest('button')) return // Let native click happen
        const nc = el && el.closest('.nc')
        const nodeEl = nc && nc.closest('.no')
        if (nodeEl && !el.closest('button')) {
          const nid = nodeEl.dataset.id; const node = S.nodes[nid]
          // Family tree nodes are not draggable â€” treat as tap only
          if (node && S.mode !== 'family') {
            T.dragNode = { id: nid, ox: t.clientX, oy: t.clientY, nx: node.x, ny: node.y, mv: false }; return
          }
        }
        T.panStart = { x: t.clientX, y: t.clientY, tx: S.tf.x, ty: S.tf.y }; T.tfStart = null
      } else if (e.touches.length === 2) {
        T.dragNode = null; T.panStart = null
        const r = cvs.getBoundingClientRect()
        T.pinchDist = tdist(e.touches[0], e.touches[1])
        T.tfStart = { ...S.tf }
        T.pinchMid = tmid(e.touches[0], e.touches[1], r)
      }
      e.preventDefault()
    }, { passive: false })

    cvs.addEventListener('touchmove', e => {
      e.preventDefault()
      if (e.touches.length === 1 && T.dragNode) {
        const t = e.touches[0]
        const dx = (t.clientX - T.dragNode.ox) / S.tf.sc, dy = (t.clientY - T.dragNode.oy) / S.tf.sc
        if (Math.abs(dx) > 3 || Math.abs(dy) > 3) T.dragNode.mv = true
        if (T.dragNode.mv) { const n = S.nodes[T.dragNode.id]; if (n) { n.x = T.dragNode.nx + dx; n.y = T.dragNode.ny + dy }; renderConns(); const el = nw.querySelector(`[data-id="${T.dragNode.id}"]`); if (el && S.nodes[T.dragNode.id]) { el.style.left = S.nodes[T.dragNode.id].x + 'px'; el.style.top = S.nodes[T.dragNode.id].y + 'px' } }
        return
      }
      if (e.touches.length === 1 && T.panStart) {
        const t = e.touches[0]
        S.tf.x = T.panStart.tx + (t.clientX - T.panStart.x)
        S.tf.y = T.panStart.ty + (t.clientY - T.panStart.y)
        applyTf(); return
      }
      if (e.touches.length === 2 && T.tfStart) {
        const r = cvs.getBoundingClientRect()
        const nd = tdist(e.touches[0], e.touches[1])
        const f = nd / T.pinchDist
        const sc = Math.max(.15, Math.min(3, T.tfStart.sc * f))
        const mx = T.pinchMid.x, my = T.pinchMid.y
        S.tf.x = mx + (T.tfStart.x - mx) * f
        S.tf.y = my + (T.tfStart.y - my) * f
        S.tf.sc = sc; applyTf()
      }
    }, { passive: false })

    cvs.addEventListener('touchend', e => {
      if (T.dragNode) {
        if (!T.dragNode.mv) {
          // It was a tap on a node card â€” single tap selects, double-tap opens panel
          const nid = T.dragNode.id
          const now = Date.now()
          S.lastTouchId = nid // flag so the synthetic click event is ignored
          if (T.lastTap && T.lastTap.id === nid && now - T.lastTap.time < 350) {
            // Double-tap as shortcut to details
            T.lastTap = null
            selNode(nid)
          } else {
            // Single tap â†’ just select (shows + buttons), close panel if open
            T.lastTap = { id: nid, time: now }
            selOnly(nid)
            closePanel()
          }
        } else {
          save(); render()
        }
        T.dragNode = null
      }
      T.panStart = null; T.tfStart = null; T.pinchDist = null
      // clear lastTouchId after a short delay so mouse click suppression expires
      setTimeout(() => { S.lastTouchId = null }, 400)
    })
    $('zi').addEventListener('click', () => zBy(1.2))
    $('zo').addEventListener('click', () => zBy(.83))
    function zBy(f) { const r = cvs.getBoundingClientRect(), cx = r.width / 2, cy = r.height / 2; S.tf.x = cx + (S.tf.x - cx) * f; S.tf.y = cy + (S.tf.y - cy) * f; S.tf.sc = Math.max(.15, Math.min(3, S.tf.sc * f)); applyTf() }
    $('rv').addEventListener('click', centre)
    function centre() { const r = cvs.getBoundingClientRect(); S.tf.x = r.width / 2; S.tf.y = r.height / 2; S.tf.sc = 1; applyTf() }

    // SELECT & PANEL
    function selOnly(id) { S.selId = id; renderNodes() }
    function selNode(id) { S.selId = id; renderNodes(); updPanel(id); $('pn').classList.add('open') }
    function updPanel(id) {
      const n = S.nodes[id]; if (!n) return
      const av = $('pa'); av.className = n.gender === 'male' ? 'm' : n.gender === 'female' ? 'f' : 'u'; av.textContent = ini(n.fullName)
      $('ptit').textContent = n.fullName || '(No name)'
      $('pnk').textContent = n.nickname ? `"${n.nickname}"` : ''; $('pnk').style.display = n.nickname ? 'block' : 'none'
      const bg = $('pbg'); bg.textContent = n.label || (n.isRoot ? 'You (Root)' : ''); bg.style.display = (n.label || n.isRoot) ? 'inline-block' : 'none'
      const sv = (eid, val) => { const el = $(eid); el.textContent = val || '--'; el.className = 'prv' + (val ? '' : ' pre') }
      sv('pph', n.phone); sv('pad2', n.address)
      sv('psp', n.spouseId ? S.nodes[n.spouseId]?.fullName : null)
      sv('ppar', n.parentIds.map(p => S.nodes[p]?.fullName || '?').join(', ') || null)
      sv('pch', n.childrenIds.map(c => S.nodes[c]?.fullName || '?').join(', ') || null)
    }
    function closePanel() { S.selId = null; $('pn').classList.remove('open'); renderNodes() }
    $('pc').addEventListener('click', closePanel)
    $('ped').addEventListener('click', () => { if (S.selId) openModal('edit', S.selId) })
    $('pdl').addEventListener('click', () => { if (!S.selId) return; const n = S.nodes[S.selId]; confirm2(`Remove "${n?.fullName || 'this person'}"?`, 'This will remove them and their connections.', () => delNode(S.selId)) })

    // MODAL
    function openModal(mode, nodeId = null, parentId = null, type = null) {
      S.modal = { mode, nodeId, parentId, type }
      const t = { edit: 'Edit Person', parent: 'Add Parent', child: 'Add Child / Descendant', spouse: 'Add Spouse / Partner', sibling: 'Add Sibling' }
      $('mt').textContent = t[mode === 'edit' ? 'edit' : type] || 'Add Person'
      $('fn').value = ''; $('fk').value = ''; $('fg').value = 'unknown'; $('fl').value = ''; $('flc').value = ''; $('flc').style.display = 'none'; $('fp').value = ''; $('fa').value = ''
      if (mode === 'edit' && nodeId) {
        const n = S.nodes[nodeId]; if (n) {
          $('fn').value = n.fullName; $('fk').value = n.nickname; $('fg').value = n.gender; $('fp').value = n.phone; $('fa').value = n.address
          const opts = [...$('fl').options].map(o => o.value)
          if (opts.includes(n.label)) $('fl').value = n.label
          else if (n.label) { $('fl').value = '__c'; $('flc').value = n.label; $('flc').style.display = 'block' }
        }
      }
      $('mo').classList.add('open'); $('fn').focus()
    }
    function closeModal() { S.modal = null; $('mo').classList.remove('open') }
    function getForm() { const ls = $('fl').value, label = ls === '__c' ? $('flc').value : ls; return { fullName: $('fn').value.trim(), nickname: $('fk').value.trim(), gender: $('fg').value, label, phone: $('fp').value.trim(), address: $('fa').value.trim() } }
    $('mc').addEventListener('click', closeModal)
    $('mca').addEventListener('click', closeModal)
    $('mo').addEventListener('click', e => { if (e.target === $('mo')) closeModal() })
    $('msv').addEventListener('click', () => {
      const d = getForm()
      if (!d.fullName) { $('fn').style.borderColor = 'var(--red)'; $('fn').focus(); return }
      $('fn').style.borderColor = ''
      const m = S.modal; if (!m) return
      if (m.mode === 'add') {
        if (m.type === 'sibling') addSiblingNode(m.parentId, d)
        else addNode(m.parentId, m.type, d)
      } else editNode(m.nodeId, d)
      closeModal()
    })
    $('fl').addEventListener('change', () => { $('flc').style.display = $('fl').value === '__c' ? 'block' : 'none'; if ($('fl').value === '__c') $('flc').focus() })
    document.addEventListener('keydown', e => {
      if (e.key !== 'Escape') return
      if ($('co').classList.contains('open')) { $('co').classList.remove('open'); S.confirmCb = null }
      else if ($('mo').classList.contains('open')) closeModal()
      else closePanel()
    })

    // SEARCH
    function doSearch(q, inputEl) {
      renderConns(); renderNodes()
      const res = $('sr')
      if (!q) { res.classList.remove('open'); return }
      const matches = Object.values(S.nodes).filter(n => mn(n, q))
      if (!matches.length) { res.innerHTML = '<div class="sri" style="color:var(--ink-faint)">No results</div>'; res.classList.add('open'); return }
      res.innerHTML = matches.slice(0, 8).map(n => `<div class="sri" data-id="${n.id}"><strong>${n.fullName || '(No name)'}</strong>${n.nickname ? ` &middot; "${n.nickname}"` : ''}${n.label ? ` <span style="color:var(--gold-lt);font-size:11px">${n.label}</span>` : ''}</div>`).join('')
      res.classList.add('open')

      const r = inputEl.getBoundingClientRect();
      if (inputEl.id === 's2') {
        // mobile search dropdown positioning
        res.style.top = (inputEl.offsetTop + inputEl.offsetHeight + 6) + 'px';
        res.style.left = inputEl.offsetLeft + 'px';
        res.style.right = (inputEl.parentElement.offsetWidth - (inputEl.offsetLeft + inputEl.offsetWidth)) + 'px';
        res.style.width = inputEl.offsetWidth + 'px';
      } else {
        res.style.top = ''; res.style.left = ''; res.style.right = ''; res.style.width = '';
      }

      res.querySelectorAll('.sri[data-id]').forEach(el => { el.addEventListener('click', () => { const node = S.nodes[el.dataset.id]; if (!node) return; inputEl.value = ''; res.classList.remove('open'); renderConns(); renderNodes(); panTo(node); selNode(node.id); if (inputEl.id === 's2') { $('mdd').classList.remove('open'); $('mbtn').classList.remove('open') } }) })
    }

    $('s').addEventListener('input', function () { doSearch(this.value.trim().toLowerCase(), this) })
    $('s2').addEventListener('input', function () { doSearch(this.value.trim().toLowerCase(), this) })
    document.addEventListener('click', e => { if (!e.target.closest('#sw')) $('sr').classList.remove('open') })
    function panTo(node) { const r = cvs.getBoundingClientRect(); S.tf.x = r.width / 2 - node.x * S.tf.sc; S.tf.y = r.height / 2 - node.y * S.tf.sc; applyTf() }

    // EXPORT/IMPORT â€” handlers are set by v2.0 code below (see doExport / doImport)

    // LINK EXISTING PICKER
    let LX = { type: null, nodeId: null }
    function openLinkPicker(type, nodeId) {
      LX = { type, nodeId }
      const labels = { parent: 'Add / Link Parent', child: 'Add / Link Child', spouse: 'Add / Link Spouse', sibling: 'Add / Link Sibling' }
      $('lxt').textContent = labels[type] || 'Link Person'
      $('lxsi').value = ''
      renderLxList('')
      $('lx').classList.add('open')
      $('lxsi').focus()
    }
    function closeLinkPicker() { $('lx').classList.remove('open') }
    $('lxc').addEventListener('click', closeLinkPicker)
    $('lx').addEventListener('click', e => { if (e.target === $('lx')) closeLinkPicker() })
    $('lxnew').addEventListener('click', () => { closeLinkPicker(); openModal('add', null, LX.nodeId, LX.type) })
    $('lxsi').addEventListener('input', function () { renderLxList(this.value.trim().toLowerCase()) })
    function renderLxList(q) {
      const from = S.nodes[LX.nodeId]; if (!from) return
      const avClass = g => g === 'male' ? 'm' : g === 'female' ? 'f' : 'u'
      const avBg = g => g === 'male' ? 'linear-gradient(135deg,#4a7fb5,#2c5f8a)' : g === 'female' ? 'linear-gradient(135deg,#c0607a,#8a3050)' : 'linear-gradient(135deg,#7a7060,#554c3a)'
      let candidates = Object.values(S.nodes).filter(n => {
        if (n.id === LX.nodeId) return false
        if (LX.type === 'parent' && from.parentIds.includes(n.id)) return false
        if (LX.type === 'child' && from.childrenIds.includes(n.id)) return false
        if (LX.type === 'spouse' && (from.spouseId || n.spouseId)) return false
        if (LX.type === 'sibling') {
          // must share a parent that from also has
          return from.parentIds.length > 0
        }
        return true
      })
      if (q) candidates = candidates.filter(n => mn(n, q))
      const list = $('lxl')
      if (!candidates.length) { list.innerHTML = '<div style="padding:16px 22px;color:var(--ink-faint);font-size:13px">No eligible people found</div>'; return }
      list.innerHTML = candidates.slice(0, 30).map(n => `
    <div class="lxi" data-id="${n.id}">
      <div class="lxiav" style="background:${avBg(n.gender)}">${ini(n.fullName)}</div>
      <div><div class="lxin">${n.fullName || '(No name)'}</div><div class="lxis">${n.nickname ? `"${n.nickname}" Â· ` : ''}${n.label || ''}</div></div>
    </div>`).join('')
      list.querySelectorAll('.lxi').forEach(el => { el.addEventListener('click', () => { linkExisting(LX.type, LX.nodeId, el.dataset.id); closeLinkPicker() }) })
    }
    function linkSiblings(a, b) {
      if (!Array.isArray(a.siblingIds)) a.siblingIds = []
      if (!Array.isArray(b.siblingIds)) b.siblingIds = []
      if (!a.siblingIds.includes(b.id)) a.siblingIds.push(b.id)
      if (!b.siblingIds.includes(a.id)) b.siblingIds.push(a.id)
    }

    function linkExisting(type, fromId, targetId) {
      const from = S.nodes[fromId], target = S.nodes[targetId]
      if (!from || !target) return
      if (type === 'parent') {
        if (from.parentIds.length >= 2) { toast('Max 2 parents'); return }
        from.parentIds.push(targetId)
        if (!target.childrenIds.includes(fromId)) target.childrenIds.push(fromId)
        if (from.parentIds.length === 2) { const ex = S.nodes[from.parentIds[0]]; if (ex) ex.x = from.x - GX / 2; target.x = from.x + GX / 2; target.y = from.y - GY }
        else { target.x = from.x; target.y = from.y - GY }
      } else if (type === 'child') {
        if (!from.childrenIds.includes(targetId)) from.childrenIds.push(targetId)
        if (!target.parentIds.includes(fromId)) target.parentIds.push(fromId)
        reposChildren(from)
      } else if (type === 'spouse') {
        if (from.spouseId || target.spouseId) { toast('One or both already have a partner'); return }
        from.spouseId = targetId; target.spouseId = fromId
        target.x = from.x + CW + 80; target.y = from.y
      } else if (type === 'sibling') {
        // Share parents
        from.parentIds.forEach(pid => {
          const par = S.nodes[pid]; if (!par) return
          if (!par.childrenIds.includes(targetId)) par.childrenIds.push(targetId)
          if (!target.parentIds.includes(pid)) target.parentIds.push(pid)
        })
        // Mark explicit sibling link so line is drawn even if no shared parent
        linkSiblings(from, target)
        if (from.parentIds[0]) reposChildren(S.nodes[from.parentIds[0]])
      }
      save(); layoutTree(); render(); toast('Linked!')
    }

    // ADD SIBLING (create new)
    function addSiblingNode(fromId, fd) {
      const from = S.nodes[fromId]; if (!from || !from.parentIds.length) { toast('Node needs a parent to add sibling'); return }
      const par = S.nodes[from.parentIds[0]]; if (!par) return
      const x = from.x + (CW + 40), y = from.y
      const node = mkNode({ ...fd, x, y }); S.nodes[node.id] = node
      par.childrenIds.push(node.id); node.parentIds.push(par.id)
      if (from.parentIds.length > 1) { const par2 = S.nodes[from.parentIds[1]]; if (par2 && !par2.childrenIds.includes(node.id)) { par2.childrenIds.push(node.id); node.parentIds.push(par2.id) } }
      // Record sibling links to all existing siblings in this family
      par.childrenIds.forEach(cid => { const sib = S.nodes[cid]; if (sib && sib.id !== node.id) linkSiblings(node, sib) })
      reposChildren(par)
      save(); layoutTree(); render(); selNode(node.id); toast('Sibling added!')
    }

    let tt; function toast(m) { const el = $('toast'); el.textContent = m; el.classList.add('show'); clearTimeout(tt); tt = setTimeout(() => el.classList.remove('show'), 2800) }

    // MOBILE MENU
    // MOVED: const mdd = $('mdd'), mbtn = $('mbtn')
    mbtn.addEventListener('click', e => { e.stopPropagation(); const open = mdd.classList.toggle('open'); mbtn.classList.toggle('open', open) })
    document.addEventListener('click', e => { if (!e.target.closest('#mdd') && !e.target.closest('#mbtn')) { mdd.classList.remove('open'); mbtn.classList.remove('open') } })
    $('mhlp').addEventListener('click', () => { mdd.classList.remove('open'); mbtn.classList.remove('open'); openWelcome() })
    // MOBILE EXPORT/IMPORT â€” handlers are set by v2.0 code below (see doExport / doImport)
    function initWelcome() {
      if (!localStorage.getItem('sl_welcomed')) { $('wm').classList.add('open') }
    }
    function openWelcome() { $('wm').classList.add('open') }
    $('wok').addEventListener('click', () => {
      localStorage.setItem('sl_welcomed', '1')
      $('wm').classList.remove('open')
    })
    $('hlp').addEventListener('click', openWelcome)
    $('wm').addEventListener('click', e => { if (e.target === $('wm')) $('wm').classList.remove('open') })

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CIRCLES v2.0 â€” DATA LAYER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Extend state
    S.circles = {}           // { [id]: { id, name, type, emoji, color, yearStart, yearEnd, subgroups: [{id,label,memberIds:[]}] } }
    S.settings = { exportPrivateNotes: false }
    S.mode = 'family'         // 'family' | 'circles'
    S.ctf = { x: 0, y: 0, sc: 1 }  // circles canvas transform

    // Override save / load for v2.0 schema
    function save() {
      try {
        const exp = {}
        Object.entries(S.nodes).forEach(([k, v]) => {
          const n = { ...v }
          exp[k] = n
        })
        localStorage.setItem('circles_v2', JSON.stringify({
          version: '2.0', nodes: exp, rootId: S.rootId,
          circles: S.circles, settings: S.settings
        }))
      } catch (e) { toast('Storage full! Export your data.') }
    }

    function load() {
      try {
        // Try v2 key first
        let raw = localStorage.getItem('circles_v2')
        if (raw) {
          const d = JSON.parse(raw)
          S.nodes = d.nodes || {}; S.rootId = d.rootId || null
          S.circles = d.circles || {}; S.settings = d.settings || { exportPrivateNotes: false }
          return true
        }
        // Fall back to old v1 key
        raw = localStorage.getItem('sl_v1')
        if (!raw) return false
        const d = JSON.parse(raw)
        S.nodes = d.nodes || {}; S.rootId = d.rootId || null
        S.circles = {}; S.settings = { exportPrivateNotes: false }
        return true
      } catch (e) { return false }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MODE SWITCHER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOVED: const tabFamily = $('tabFamily'), tabCircles = $('tabCircles')
    // MOVED: const circlesCanvas = $('circlesCanvas')
    // MOVED: const addGroupBtn = $('addGroupBtn')
    // MOVED: const circlesCC = $('circlesCC')

    function switchMode(mode) {
      S.mode = mode
      const isFam = mode === 'family'
      $('cw').style.display = isFam ? '' : 'none'
      $('cc').style.display = isFam ? '' : 'none'
      $('leg').style.display = isFam ? '' : 'none'
      circlesCanvas.classList.toggle('active', !isFam)
      addGroupBtn.classList.toggle('active', !isFam)
      circlesCC.classList.toggle('active', !isFam)
      tabFamily.classList.toggle('active', isFam)
      tabCircles.classList.toggle('active', !isFam)
      if (!isFam) renderCirclesView()
    }

    tabFamily.addEventListener('click', () => switchMode('family'))
    tabCircles.addEventListener('click', () => switchMode('circles'))

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CIRCLES CANVAS â€” RENDERING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOVED: const cWorld = $('circlesWorld')
    // MOVED: const cSvgG = $('csg')
    let CCtf = { x: 0, y: 0, sc: 1 }
    let expandedGroupId = null

    function applyCTf() {
      const { x, y, sc } = CCtf
      cWorld.style.transform = `translate(${x}px,${y}px) scale(${sc})`
      cWorld.style.transformOrigin = '0 0'
      cSvgG.setAttribute('transform', `translate(${x},${y}) scale(${sc})`)
    }

    function groupTotalMembers(g) {
      return (g.subgroups || []).reduce((s, sg) => s + (sg.memberIds || []).length, 0)
    }

    function getUserName() {
      const root = S.nodes[S.rootId]
      return root ? (root.nickname || root.fullName || 'You') : 'You'
    }

    function renderCirclesView() {
      cWorld.innerHTML = ''
      cSvgG.innerHTML = ''
      const cvs = circlesCanvas
      const r = cvs.getBoundingClientRect()
      const cx = r.width / 2, cy = r.height / 2

      // â”€â”€ User centre node â”€â”€
      const userEl = document.createElement('div')
      userEl.className = 'c-user'
      userEl.style.left = cx + 'px'; userEl.style.top = cy + 'px'
      userEl.innerHTML = `<span class="c-user-emoji">ðŸ«‚</span><span class="c-user-label">${getUserName()}</span>`
      cWorld.appendChild(userEl)

      // â”€â”€ Lay out group bubbles in a circle around the user â”€â”€
      const groups = Object.values(S.circles)
      const R = Math.min(cx, cy) * 0.55   // orbit radius
      const total = groups.length

      groups.forEach((g, i) => {
        const angle = (2 * Math.PI * i / Math.max(total, 1)) - Math.PI / 2
        // Use stored position (from drag) or compute from orbit
        const gx = (g.cx !== undefined) ? cx + g.cx : cx + R * Math.cos(angle)
        const gy = (g.cy !== undefined) ? cy + g.cy : cy + R * Math.sin(angle)

        // Initialise stored offset on first render
        if (g.cx === undefined) { g.cx = R * Math.cos(angle); g.cy = R * Math.sin(angle) }

        // SVG line: user â†’ group
        const lineEl = document.createElementNS('http://www.w3.org/2000/svg', 'line')
        lineEl.setAttribute('x1', cx); lineEl.setAttribute('y1', cy)
        lineEl.setAttribute('x2', gx); lineEl.setAttribute('y2', gy)
        lineEl.setAttribute('class', 'c-line')
        lineEl.dataset.lgid = g.id
        cSvgG.appendChild(lineEl)

        const el = document.createElement('div')
        el.className = 'c-group' + (expandedGroupId === g.id ? ' expanded' : '')
        el.dataset.gid = g.id
        el.style.left = gx + 'px'; el.style.top = gy + 'px'
        el.style.background = hexAlpha(g.color, 0.15)
        el.style.borderColor = g.color
        el.style.color = g.color
        el.style.boxShadow = `0 0 20px ${hexAlpha(g.color, 0.2)}`
        const totalM = groupTotalMembers(g)
        const yrLabel = g.yearStart ? ` '${String(g.yearStart).slice(-2)}${g.yearEnd ? `â€“'${String(g.yearEnd).slice(-2)}` : '+'}` : ''
        el.innerHTML = `
          <span class="c-group-emoji">${g.emoji}</span>
          <span class="c-group-name" style="color:${g.color}">${g.name}${yrLabel}</span>
          <span class="c-group-count" style="background:${hexAlpha(g.color, 0.2)};color:${g.color}">${totalM} people</span>`

        // â”€â”€ Group events: context menu, drag, click â”€â”€
        el.addEventListener('contextmenu', e => { e.preventDefault(); openGroupCtx(g.id, e.clientX, e.clientY) })

        // Mouse drag + click
        let _gDragged = false
        el.addEventListener('mousedown', e => {
          if (e.button !== 0 || e.target.closest('.c-subgroup')) return
          e.stopPropagation()
          const startX = e.clientX, startY = e.clientY
          const origCx = g.cx, origCy = g.cy
          _gDragged = false
          function onMove(me) {
            const dx = (me.clientX - startX) / CCtf.sc
            const dy = (me.clientY - startY) / CCtf.sc
            if (Math.abs(dx) > 4 || Math.abs(dy) > 4) _gDragged = true
            if (!_gDragged) return
            g.cx = origCx + dx; g.cy = origCy + dy
            const ngx = cx + g.cx, ngy = cy + g.cy
            el.style.left = ngx + 'px'; el.style.top = ngy + 'px'
            const ln = cSvgG.querySelector(`[data-lgid="${g.id}"]`)
            if (ln) { ln.setAttribute('x2', ngx); ln.setAttribute('y2', ngy) }
          }
          function onUp() {
            document.removeEventListener('mousemove', onMove)
            document.removeEventListener('mouseup', onUp)
            if (_gDragged) { save(); renderCirclesView() }
          }
          document.addEventListener('mousemove', onMove)
          document.addEventListener('mouseup', onUp)
        })
        el.addEventListener('click', e => {
          if (e.target.closest('.c-subgroup')) return
          if (_gDragged) { _gDragged = false; return }
          expandedGroupId = expandedGroupId === g.id ? null : g.id
          renderCirclesView()
        })

        // Touch: drag + long-press (context menu)
        el.addEventListener('touchstart', e => {
          if (e.touches.length !== 1 || e.target.closest('.c-subgroup')) return
          const t0 = e.touches[0]
          const startX = t0.clientX, startY = t0.clientY
          const origCx = g.cx, origCy = g.cy
          let moved = false
          const pressTimer = setTimeout(() => openGroupCtx(g.id, null, null), 650)
          function onTm(te) {
            const t = te.touches[0]
            const dx = (t.clientX - startX) / CCtf.sc, dy = (t.clientY - startY) / CCtf.sc
            if (Math.abs(dx) > 6 || Math.abs(dy) > 6) { moved = true; clearTimeout(pressTimer) }
            if (!moved) return
            g.cx = origCx + dx; g.cy = origCy + dy
            const ngx = cx + g.cx, ngy = cy + g.cy
            el.style.left = ngx + 'px'; el.style.top = ngy + 'px'
            const ln = cSvgG.querySelector(`[data-lgid="${g.id}"]`)
            if (ln) { ln.setAttribute('x2', ngx); ln.setAttribute('y2', ngy) }
          }
          function onTu() {
            clearTimeout(pressTimer)
            el.removeEventListener('touchmove', onTm)
            el.removeEventListener('touchend', onTu)
            if (moved) { save(); renderCirclesView() }
          }
          el.addEventListener('touchmove', onTm, { passive: true })
          el.addEventListener('touchend', onTu)
        }, { passive: true })

        cWorld.appendChild(el)

        if (expandedGroupId === g.id) {
          const subs = g.subgroups || []
          const SR = 120   // sub-group orbit radius from group centre
          subs.forEach((sg, si) => {
            const subAngle = angle + (2 * Math.PI * si / Math.max(subs.length, 1))
            const sx = gx + SR * Math.cos(subAngle)
            const sy = gy + SR * Math.sin(subAngle)

            drawCLine(cSvgG, gx, gy, sx, sy, 'c-line-sub')

            const sel = document.createElement('div')
            sel.className = 'c-subgroup'
            sel.dataset.gid = g.id; sel.dataset.sgid = sg.id
            sel.style.left = sx + 'px'; sel.style.top = sy + 'px'
            sel.innerHTML = `
              <span class="c-subgroup-label">${sg.label}</span>
              <span class="c-subgroup-count">${(sg.memberIds || []).length} ðŸ‘¤</span>`

            // Animate in after a frame
            requestAnimationFrame(() => { requestAnimationFrame(() => sel.classList.add('visible')) })

            sel.addEventListener('click', e => {
              e.stopPropagation()
              openPeopleModal(g.id, sg.id)
            })

            cWorld.appendChild(sel)
          })
        }
      })
    }

    function drawCLine(svgG, x1, y1, x2, y2, cls) {
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line')
      line.setAttribute('x1', x1); line.setAttribute('y1', y1)
      line.setAttribute('x2', x2); line.setAttribute('y2', y2)
      line.setAttribute('class', cls)
      svgG.appendChild(line)
    }

    function hexAlpha(hex, a) {
      const r = parseInt(hex.slice(1, 3), 16)
      const g = parseInt(hex.slice(3, 5), 16)
      const b = parseInt(hex.slice(5, 7), 16)
      return `rgba(${r},${g},${b},${a})`
    }

    // Circles canvas pan & zoom
    const cvs2 = circlesCanvas
    let cpan = false, cpo = null
    cvs2.addEventListener('mousedown', e => {
      if (e.target.closest('.c-group') || e.target.closest('.c-subgroup') || e.target.closest('.c-user')) return
      cpan = true; cpo = { x: e.clientX, y: e.clientY, tx: CCtf.x, ty: CCtf.y }
      cvs2.classList.add('pan')
    })
    document.addEventListener('mousemove', e => {
      if (cpan && cpo) { CCtf.x = cpo.tx + (e.clientX - cpo.x); CCtf.y = cpo.ty + (e.clientY - cpo.y); applyCTf() }
    })
    document.addEventListener('mouseup', () => { cpan = false; cpo = null; cvs2.classList.remove('pan') })
    cvs2.addEventListener('wheel', e => {
      e.preventDefault()
      const f = e.deltaY < 0 ? 1.08 : .93
      const r = cvs2.getBoundingClientRect(), mx = e.clientX - r.left, my = e.clientY - r.top
      CCtf.x = mx + (CCtf.x - mx) * f; CCtf.y = my + (CCtf.y - my) * f
      CCtf.sc = Math.max(.2, Math.min(3, CCtf.sc * f)); applyCTf()
    }, { passive: false })
    $('czi').addEventListener('click', () => czBy(1.2))
    $('czo').addEventListener('click', () => czBy(.83))
    $('crv').addEventListener('click', () => { CCtf = { x: 0, y: 0, sc: 1 }; applyCTf() })
    function czBy(f) {
      const r = cvs2.getBoundingClientRect(), cx = r.width / 2, cy = r.height / 2
      CCtf.x = cx + (CCtf.x - cx) * f; CCtf.y = cy + (CCtf.y - cy) * f
      CCtf.sc = Math.max(.2, Math.min(3, CCtf.sc * f)); applyCTf()
    }

    // Touch pan for circles canvas
    let CT = { panStart: null }
    cvs2.addEventListener('touchstart', e => {
      if (e.touches.length === 1) {
        const t = e.touches[0]
        if (document.elementFromPoint(t.clientX, t.clientY)?.closest('.c-group,.c-subgroup,.c-user')) return
        CT.panStart = { x: t.clientX, y: t.clientY, tx: CCtf.x, ty: CCtf.y }
      }
    }, { passive: true })
    cvs2.addEventListener('touchmove', e => {
      if (e.touches.length === 1 && CT.panStart) {
        const t = e.touches[0]
        CCtf.x = CT.panStart.tx + (t.clientX - CT.panStart.x)
        CCtf.y = CT.panStart.ty + (t.clientY - CT.panStart.y)
        applyCTf()
      }
    }, { passive: true })
    cvs2.addEventListener('touchend', () => { CT.panStart = null })

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  GROUP CONTEXT MENU
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let ctxGroupId = null
    // MOVED: const groupCtxMenu = $('groupCtxMenu')

    function openGroupCtx(gid, mx, my) {
      ctxGroupId = gid
      groupCtxMenu.classList.add('open')
      if (mx !== null) {
        groupCtxMenu.style.left = Math.min(mx, window.innerWidth - 180) + 'px'
        groupCtxMenu.style.top = Math.min(my, window.innerHeight - 140) + 'px'
      } else {
        groupCtxMenu.style.left = '50%'; groupCtxMenu.style.top = '50%'
        groupCtxMenu.style.transform = 'translate(-50%,-50%)'
      }
    }

    document.addEventListener('click', e => {
      if (!e.target.closest('#groupCtxMenu')) { groupCtxMenu.classList.remove('open'); groupCtxMenu.style.transform = '' }
    })

    $('ctxEditGroup').addEventListener('click', () => {
      groupCtxMenu.classList.remove('open')
      if (ctxGroupId) openGroupModal('edit', ctxGroupId)
    })
    $('ctxAddSub').addEventListener('click', () => {
      groupCtxMenu.classList.remove('open')
      if (ctxGroupId) {
        const label = prompt('Sub-group name:')
        if (!label?.trim()) return
        const g = S.circles[ctxGroupId]; if (!g) return
        if (!g.subgroups) g.subgroups = []
        g.subgroups.push({ id: uid(), label: label.trim(), memberIds: [] })
        save(); renderCirclesView(); toast('Sub-group added!')
      }
    })
    $('ctxDelGroup').addEventListener('click', () => {
      groupCtxMenu.classList.remove('open')
      if (!ctxGroupId) return
      const g = S.circles[ctxGroupId]
      confirm2(`Delete "${g?.name}"?`, 'Members are kept. Only this group and its sub-groups are removed.', () => {
        delete S.circles[ctxGroupId]
        if (expandedGroupId === ctxGroupId) expandedGroupId = null
        save(); renderCirclesView(); toast('Group deleted.')
      })
    })

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CREATE / EDIT GROUP MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let GM = { mode: 'create', gid: null, color: '#4a7fb5', subgroups: [] }
    const PALETTE_COLORS = ['#4a7fb5', '#16a085', '#8a60c0', '#c8963e', '#c0392b', '#27ae60']

    addGroupBtn.addEventListener('click', () => openGroupModal('create'))
    $('groupMclose').addEventListener('click', closeGroupModal)
    $('groupMcancel').addEventListener('click', closeGroupModal)
    $('groupMo').addEventListener('click', e => { if (e.target === $('groupMo')) closeGroupModal() })

    function openGroupModal(mode, gid = null) {
      GM.mode = mode; GM.gid = gid
      $('groupMtitle').textContent = mode === 'edit' ? 'Edit Group' : 'New Group'

      // Reset type buttons
      document.querySelectorAll('.gtype-btn').forEach(b => b.classList.remove('sel'))
      document.querySelector('.gtype-btn[data-type="school"]').classList.add('sel')
      GM.color = '#4a7fb5'
      GM.subgroups = ['Friends', 'Teachers', 'Classmates']

      if (mode === 'edit' && gid) {
        const g = S.circles[gid]; if (!g) return
        $('gname').value = g.name; $('gemoji').value = g.emoji
        $('gyearS').value = g.yearStart || ''; $('gyearE').value = g.yearEnd || ''
        GM.color = g.color; GM.subgroups = (g.subgroups || []).map(s => s.label)
        document.querySelectorAll('.gtype-btn').forEach(b => {
          if (b.dataset.type === g.type) b.classList.add('sel')
          else b.classList.remove('sel')
        })
      } else {
        $('gname').value = ''; $('gemoji').value = 'ðŸ«'
        $('gyearS').value = ''; $('gyearE').value = ''
      }

      refreshGColorRow(); refreshGSgList()
      $('groupMo').classList.add('open'); $('gname').focus()
    }

    function closeGroupModal() { $('groupMo').classList.remove('open') }

    function refreshGColorRow() {
      document.querySelectorAll('.gcolor-swatch').forEach(s => s.classList.toggle('sel', s.dataset.color === GM.color))
    }

    function refreshGSgList() {
      const list = $('gsgList')
      list.innerHTML = GM.subgroups.map((sg, i) => `
        <div class="gsg-tag">${sg}<button class="gsg-tag-del" data-i="${i}">&times;</button></div>`).join('')
      list.querySelectorAll('.gsg-tag-del').forEach(btn => {
        btn.addEventListener('click', () => { GM.subgroups.splice(+btn.dataset.i, 1); refreshGSgList() })
      })
    }

    // Type button selection
    document.querySelectorAll('.gtype-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.gtype-btn').forEach(b => b.classList.remove('sel'))
        btn.classList.add('sel')
        $('gemoji').value = btn.dataset.emoji
        GM.color = btn.dataset.color; refreshGColorRow()
        GM.subgroups = btn.dataset.subs ? btn.dataset.subs.split(',') : []
        refreshGSgList()
      })
    })

    // Color swatches
    document.querySelectorAll('.gcolor-swatch').forEach(s => {
      s.addEventListener('click', () => { GM.color = s.dataset.color; refreshGColorRow() })
    })

    // Sub-group input
    $('gsgInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && $('gsgInput').value.trim()) {
        GM.subgroups.push($('gsgInput').value.trim()); $('gsgInput').value = ''; refreshGSgList()
      }
    })

    $('groupMsave').addEventListener('click', () => {
      const name = $('gname').value.trim(); if (!name) { $('gname').style.borderColor = 'var(--red)'; $('gname').focus(); return }
      $('gname').style.borderColor = ''
      const selType = document.querySelector('.gtype-btn.sel')

      if (GM.mode === 'create') {
        const gid = uid()
        // Preserve existing subgroups if editing, else create fresh
        const existingSubs = GM.subgroups.map(label => ({ id: uid(), label, memberIds: [] }))
        S.circles[gid] = {
          id: gid, name, type: selType?.dataset.type || 'custom',
          emoji: $('gemoji').value || (selType?.dataset.emoji) || 'âœï¸',
          color: GM.color,
          yearStart: $('gyearS').value ? +$('gyearS').value : null,
          yearEnd: $('gyearE').value ? +$('gyearE').value : null,
          subgroups: existingSubs
        }
        toast('Group created!')
      } else {
        const g = S.circles[GM.gid]; if (!g) return
        // Preserve existing sub-group member lists when editing
        const existingMap = {}; (g.subgroups || []).forEach(s => existingMap[s.label] = s)
        g.name = name; g.type = selType?.dataset.type || 'custom'
        g.emoji = $('gemoji').value || (selType?.dataset.emoji) || 'âœï¸'
        g.color = GM.color
        g.yearStart = $('gyearS').value ? +$('gyearS').value : null
        g.yearEnd = $('gyearE').value ? +$('gyearE').value : null
        g.subgroups = GM.subgroups.map(label =>
          existingMap[label] ? existingMap[label] : { id: uid(), label, memberIds: [] }
        )
        toast('Group updated!')
      }
      closeGroupModal(); save(); renderCirclesView()
    })

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PEOPLE LIST MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let PM = { gid: null, sgid: null, editNodeId: null }

    function avBg(gender) {
      return gender === 'male' ? 'linear-gradient(135deg,#4a7fb5,#2c5f8a)'
        : gender === 'female' ? 'linear-gradient(135deg,#c0607a,#8a3050)'
          : 'linear-gradient(135deg,#7a7060,#554c3a)'
    }

    const STR_LABELS = { close_friend: 'Close Friend', friend: 'Friend', acquaintance: 'Acquaintance', lost_touch: 'Lost Touch' }
    const STR_CLS = { close_friend: 'close', friend: 'friend', acquaintance: 'acquaintance', lost_touch: 'lost' }
    const STR_AV = { close_friend: 'str-close', friend: '', acquaintance: '', lost_touch: 'str-lost' }

    function openPeopleModal(gid, sgid) {
      PM.gid = gid; PM.sgid = sgid; PM.editNodeId = null
      const g = S.circles[gid]; if (!g) return
      const sg = (g.subgroups || []).find(s => s.id === sgid); if (!sg) return
      $('pmGroupLabel').textContent = `${g.emoji} ${g.name}`
      $('pmSubLabel').textContent = sg.label
      closeCpf(); closeLinkFam()
      renderPplList(g, sg)
      $('peopleMo').classList.add('open')
    }

    function closePeopleModal() { $('peopleMo').classList.remove('open'); closeCpf(); closeLinkFam() }
    $('peopleMclose').addEventListener('click', closePeopleModal)
    $('peopleMo').addEventListener('click', e => { if (e.target === $('peopleMo')) closePeopleModal() })

    function renderPplList(g, sg) {
      const list = $('pplList')
      const members = (sg.memberIds || []).map(id => S.nodes[id]).filter(Boolean)
      if (!members.length) {
        list.innerHTML = '<div class="ppl-empty">No one here yet.<br><span style="font-size:12px">Add people using the buttons below.</span></div>'
        return
      }
      list.innerHTML = members.map(n => {
        const str = n.relationshipStrength || 'friend'
        const isFam = n.parentIds?.length || n.childrenIds?.length || n.isRoot
        return `<div class="ppl-row" data-nid="${n.id}">
          <div class="ppl-av ${STR_AV[str]}" style="background:${avBg(n.gender)}">${ini(n.fullName)}</div>
          <div class="ppl-info">
            <div class="ppl-name">${n.fullName || '(No name)'}</div>
            ${n.nickname ? `<div class="ppl-nick">"${n.nickname}"</div>` : ''}
            <span class="ppl-badge ${STR_CLS[str]}">${STR_LABELS[str]}</span>
            ${isFam ? '<span class="ppl-badge family" style="margin-left:4px">ðŸŒ³ Family</span>' : ''}
          </div>
          <div class="ppl-actions">
            <button class="ppl-act edit" data-nid="${n.id}" title="Edit">âœï¸</button>
            <button class="ppl-act del" data-nid="${n.id}" title="Remove">ðŸ—‘</button>
          </div>
        </div>`
      }).join('')

      list.querySelectorAll('.ppl-act.edit').forEach(btn => {
        btn.addEventListener('click', () => openCpf('edit', btn.dataset.nid))
      })
      list.querySelectorAll('.ppl-act.del').forEach(btn => {
        btn.addEventListener('click', () => {
          const g2 = S.circles[PM.gid]; if (!g2) return
          const sg2 = (g2.subgroups || []).find(s => s.id === PM.sgid); if (!sg2) return
          confirm2('Remove person?', 'They will stay in the family tree if they are a family member.', () => {
            sg2.memberIds = (sg2.memberIds || []).filter(id => id !== btn.dataset.nid)
            save(); renderCirclesView(); const g3 = S.circles[PM.gid]; const sg3 = (g3?.subgroups || []).find(s => s.id === PM.sgid)
            if (g3 && sg3) renderPplList(g3, sg3); else closePeopleModal()
            toast('Removed.')
          })
        })
      })
    }

    // ADD / EDIT INLINE FORM
    function openCpf(mode, nodeId = null) {
      PM.editNodeId = mode === 'edit' ? nodeId : null
      closeLinkFam()
      $('cpfTitle').textContent = mode === 'edit' ? 'Edit Person' : 'Add Person'
      $('cpfName').value = ''; $('cpfNick').value = ''; $('cpfGender').value = 'unknown'
      $('cpfPhone').value = ''; $('cpfMet').value = ''; $('cpfMetOn').value = ''; $('cpfNote').value = ''
      // Reset str radio
      document.querySelectorAll('.str-radio').forEach(r => r.classList.remove('sel'))
      document.querySelector('.str-radio[data-val="close_friend"]').classList.add('sel')
      document.querySelector('input[name="str"][value="close_friend"]').checked = true

      if (mode === 'edit' && nodeId) {
        const n = S.nodes[nodeId]; if (!n) return
        $('cpfName').value = n.fullName; $('cpfNick').value = n.nickname || ''
        $('cpfGender').value = n.gender || 'unknown'; $('cpfPhone').value = n.phone || ''
        $('cpfMet').value = n.howWeMet || ''; $('cpfMetOn').value = n.metOn || ''; $('cpfNote').value = n.privateNote || ''
        const str = n.relationshipStrength || 'close_friend'
        document.querySelectorAll('.str-radio').forEach(r => r.classList.toggle('sel', r.dataset.val === str))
        const ri = document.querySelector(`input[name="str"][value="${str}"]`); if (ri) ri.checked = true
      }
      $('circlePersonForm').classList.add('open')
      $('cpfName').focus()
    }
    function closeCpf() { $('circlePersonForm').classList.remove('open'); PM.editNodeId = null }

    // Relationship radio UX
    document.querySelectorAll('.str-radio').forEach(label => {
      label.addEventListener('click', () => {
        document.querySelectorAll('.str-radio').forEach(r => r.classList.remove('sel'))
        label.classList.add('sel')
      })
    })

    $('btnAddPerson').addEventListener('click', () => {
      closeLinkFam(); openCpf('add')
    })
    $('cpfCancel').addEventListener('click', closeCpf)

    $('cpfSave').addEventListener('click', () => {
      const name = $('cpfName').value.trim(); if (!name) { $('cpfName').style.borderColor = 'var(--red)'; $('cpfName').focus(); return }
      $('cpfName').style.borderColor = ''
      const strVal = document.querySelector('input[name="str"]:checked')?.value || 'friend'
      const data = {
        fullName: name, nickname: $('cpfNick').value.trim(), gender: $('cpfGender').value,
        phone: $('cpfPhone').value.trim(), howWeMet: $('cpfMet').value.trim(),
        metOn: $('cpfMetOn').value, privateNote: $('cpfNote').value.trim(),
        relationshipStrength: strVal
      }

      if (PM.editNodeId) {
        // Editing existing node
        const n = S.nodes[PM.editNodeId]; if (!n) return
        Object.assign(n, data)
        toast('Updated!')
      } else {
        // New node â€” create and add to subgroup
        const nid = uid()
        S.nodes[nid] = { id: nid, parentIds: [], childrenIds: [], spouseId: null, siblingIds: [], isRoot: false, x: 0, y: 0, label: '', ...data }
        const g = S.circles[PM.gid]; if (!g) return
        const sg = (g.subgroups || []).find(s => s.id === PM.sgid); if (!sg) return
        if (!sg.memberIds) sg.memberIds = []
        sg.memberIds.push(nid)
        toast('Person added!')
      }

      save(); renderCirclesView()
      const g2 = S.circles[PM.gid]; const sg2 = (g2?.subgroups || []).find(s => s.id === PM.sgid)
      if (g2 && sg2) renderPplList(g2, sg2)
      closeCpf()
    })

    // LINK FROM FAMILY TREE
    $('btnLinkFam').addEventListener('click', () => {
      closeCpf()
      const lfs = $('linkFamSearch')
      lfs.classList.toggle('open')
      if (lfs.classList.contains('open')) {
        $('linkFamInput').value = ''; renderLinkFamResults(''); $('linkFamInput').focus()
      }
    })
    function closeLinkFam() { $('linkFamSearch').classList.remove('open'); $('linkFamResults').innerHTML = '' }

    $('linkFamInput').addEventListener('input', function () { renderLinkFamResults(this.value.trim().toLowerCase()) })

    function renderLinkFamResults(q) {
      const out = $('linkFamResults')
      const g = S.circles[PM.gid]; const sg = g && (g.subgroups || []).find(s => s.id === PM.sgid)
      const existing = new Set(sg?.memberIds || [])
      let candidates = Object.values(S.nodes).filter(n => !existing.has(n.id) && (n.parentIds?.length || n.childrenIds?.length || n.isRoot))
      if (q) candidates = candidates.filter(n => mn(n, q))
      if (!candidates.length) { out.innerHTML = '<div style="padding:8px 12px;color:var(--ink-faint);font-size:12px">No family members found.</div>'; return }
      out.innerHTML = candidates.slice(0, 20).map(n => `
        <div class="lfr-item" data-nid="${n.id}">
          <div class="lfr-av" style="background:${avBg(n.gender)}">${ini(n.fullName)}</div>
          <div><div class="lfr-name">${n.fullName || '(No name)'}</div>
          <div class="lfr-sub">${n.nickname ? `"${n.nickname}" Â· ` : ''}${n.label || ''} ðŸŒ³</div></div>
        </div>`).join('')
      out.querySelectorAll('.lfr-item').forEach(el => {
        el.addEventListener('click', () => {
          if (!sg) return
          if (!sg.memberIds) sg.memberIds = []
          if (sg.memberIds.includes(el.dataset.nid)) { toast('Already in this sub-group'); return }
          sg.memberIds.push(el.dataset.nid)
          save(); closeLinkFam(); renderCirclesView(); renderPplList(g, sg); toast('Linked from family tree!')
        })
      })
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEARCH UPGRADE (Family + Circles)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function doSearch(q, inputEl) {
      if (S.mode === 'family') { renderConns(); renderNodes() }
      const res = $('sr')
      if (!q) { res.classList.remove('open'); return }

      const matches = []

      // Family matches
      Object.values(S.nodes).forEach(n => {
        if (!mn(n, q)) return
        // Check if also in circles
        const circleBadges = []
        Object.values(S.circles).forEach(g => {
          (g.subgroups || []).forEach(sg => {
            if ((sg.memberIds || []).includes(n.id)) circleBadges.push(`ðŸ”µ ${g.name} â€º ${sg.label}`)
          })
        })
        const isFamNode = n.parentIds?.length || n.childrenIds?.length || n.isRoot
        matches.push({ n, badges: isFamNode ? ['ðŸŒ³ Family', ...circleBadges] : circleBadges.length ? circleBadges : ['ðŸŒ³ Family'] })
      })

      // Circles-only members (not in family at all)
      const famIds = new Set(Object.values(S.nodes).map(n => n.id))
      // already covered above since all nodes share the same S.nodes pool

      if (!matches.length) { res.innerHTML = '<div class="sri" style="color:var(--ink-faint)">No results</div>'; res.classList.add('open'); return }

      res.innerHTML = matches.slice(0, 10).map(({ n, badges }) =>
        `<div class="sri" data-id="${n.id}">
          <strong>${n.fullName || '(No name)'}</strong>${n.nickname ? ` Â· "${n.nickname}"` : ''}
          <div style="margin-top:3px;display:flex;gap:4px;flex-wrap:wrap">${badges.map(b => `<span style="font-size:10px;color:var(--gold-lt)">${b}</span>`).join('')}</div>
        </div>`).join('')
      res.classList.add('open')

      if (inputEl.id === 's2') {
        res.style.top = (inputEl.offsetTop + inputEl.offsetHeight + 6) + 'px'
        res.style.left = inputEl.offsetLeft + 'px'; res.style.right = (inputEl.parentElement.offsetWidth - (inputEl.offsetLeft + inputEl.offsetWidth)) + 'px'
        res.style.width = inputEl.offsetWidth + 'px'
      } else { res.style.top = ''; res.style.left = ''; res.style.right = ''; res.style.width = '' }

      res.querySelectorAll('.sri[data-id]').forEach(el => {
        el.addEventListener('click', () => {
          const node = S.nodes[el.dataset.id]; if (!node) return
          inputEl.value = ''; res.classList.remove('open')
          if (S.mode === 'circles') switchMode('family')
          renderConns(); renderNodes(); panTo(node); selNode(node.id)
          if (inputEl.id === 's2') { $('mdd').classList.remove('open'); $('mbtn').classList.remove('open') }
        })
      })
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  EXPORT / IMPORT UPGRADE (v2.0)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildExportData(includePrivate) {
      const exportNodes = {}
      Object.entries(S.nodes).forEach(([k, v]) => {
        const n = { ...v }
        if (!includePrivate) delete n.privateNote
        exportNodes[k] = n
      })
      return JSON.stringify({
        version: '2.0', exportedAt: new Date().toISOString(),
        rootNodeId: S.rootId, nodes: exportNodes,
        circles: S.circles, settings: { exportPrivateNotes: includePrivate }
      }, null, 2)
    }

    function doExport() {
      confirm2('Export Options', 'Include private notes in the export?', () => {
        const blob = new Blob([buildExportData(true)], { type: 'application/json' })
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob)
        a.download = `circles-${new Date().toISOString().slice(0, 10)}.json`; a.click()
        URL.revokeObjectURL(a.href); toast('Exported with private notes!')
      })
      // Also trigger the default no-private-notes export immediately via backdrop dismiss
      // Actually: show a toast and immediately export without notes (cancel = no notes)
      const blob = new Blob([buildExportData(false)], { type: 'application/json' })
      const downloadDefault = () => {
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob)
        a.download = `circles-${new Date().toISOString().slice(0, 10)}.json`; a.click()
        URL.revokeObjectURL(a.href); toast('Exported!')
      }
      // Override: use a simple approach â€” export without notes, and the confirm is "include private?"
      // Re-wire confirm to only export with private if YES pressed
      // We already hooked confirm2 above, so just make "no" export default
      const origCb = S.confirmCb
      const cno = $('cno')
      const origCnoClick = cno.onclick
      cno.onclick = () => {
        $('co').classList.remove('open'); S.confirmCb = null
        downloadDefault(); cno.onclick = origCnoClick
      }
    }

    function doImport(file, onDone) {
      const reader = new FileReader()
      reader.onload = e => {
        try {
          const d = JSON.parse(e.target.result)
          if (!d.nodes || !d.rootNodeId) throw new Error('Invalid format')
          const count = Object.keys(d.nodes).length
          const hasCircles = d.circles && Object.keys(d.circles).length > 0
          confirm2(
            `Import ${count} people${hasCircles ? ' + circles' : ''}?`,
            'This will replace your current data. Export first to keep a backup.',
            () => {
              S.nodes = d.nodes; S.rootId = d.rootNodeId
              S.circles = d.circles || {}; S.settings = d.settings || { exportPrivateNotes: false }
              S.selId = null; closePanel(); save(); layoutTree(); render()
              if (S.mode === 'circles') renderCirclesView()
              centre(); toast(`Imported ${count} people${hasCircles ? ' + circles' : ''}!`)
            }
          )
        } catch (err) { toast('Invalid file. Use a Circles JSON export.') }
      }
      reader.readAsText(file); if (onDone) onDone()
    }

    // Wire up export/import buttons (override previous handlers)
    $('exp').onclick = doExport
    $('imp').onchange = function () { const f = this.files[0]; if (!f) return; doImport(f, () => { this.value = '' }) }
    $('mexp').onclick = () => { $('mdd').classList.remove('open'); $('mbtn').classList.remove('open'); doExport() }
    $('mimp').onchange = function () {
      const f = this.files[0]; if (!f) return
      $('mdd').classList.remove('open'); $('mbtn').classList.remove('open')
      doImport(f, () => { this.value = '' })
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function init() {
      const ok = load()
      if (!ok || !Object.keys(S.nodes).length) initRoot()
      layoutTree(); centre(); render(); initWelcome()
    }
    init()

    // PWA
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('circles-sw.js').catch(() => { }) }) }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  THEME TOGGLE (dark / light)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function applyTheme(theme) {
      document.documentElement.dataset.theme = theme
      const isDark = theme === 'dark'
      const icon = isDark ? 'ðŸŒ™' : 'â˜€ï¸'
      const btn = $('thmBtn'); if (btn) btn.textContent = icon
      const mbtn2 = $('mthmBtn'); if (mbtn2) mbtn2.querySelector('.mdi-icon').textContent = icon
      // Update theme-color meta
      const meta = document.querySelector('meta[name="theme-color"]')
      if (meta) meta.content = isDark ? '#0d0c08' : '#f4efe2'
    }
    function toggleTheme() {
      const current = document.documentElement.dataset.theme || 'dark'
      const next = current === 'dark' ? 'light' : 'dark'
      localStorage.setItem('circles_theme', next)
      applyTheme(next)
    }
    ; (function initTheme() {
      const saved = localStorage.getItem('circles_theme') || 'dark'
      applyTheme(saved)
    })()
    $('thmBtn').addEventListener('click', toggleTheme)
    $('mthmBtn').addEventListener('click', () => {
      mdd.classList.remove('open'); mbtn.classList.remove('open'); toggleTheme()
    })

  </script>
</body>

</html>