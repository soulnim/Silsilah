
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --bg: var(--bg);
      --surface: #1a1812;
      --border: #2e2b20;
      --gold: #c8963e;
      --gold-lt: #e8b85a;
      --gold-dim: rgba(200, 150, 62, .15);
      --cream: #f5eedc;
      --paper: #faf6ec;
      --ink: #1e1a0f;
      --ink-soft: #4a4232;
      --ink-faint: #8a7d60;
      --red: #c0392b;
      --teal: #16a085;
      --cw: 200px;
      --ch: 138px;
      --r: 10px;
      --sh: 0 4px 24px rgba(0, 0, 0, .18), 0 1px 4px rgba(0, 0, 0, .1);
      --sh2: 0 8px 40px rgba(0, 0, 0, .28), 0 2px 8px rgba(0, 0, 0, .14);
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--cream);
      font-family: 'Lato', sans-serif
    }

    /* TOPBAR */
    #tb {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      background: rgba(13, 12, 8, .92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border)
    }

    #logo {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0
    }

    #lt {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--gold)
    }

    #ls {
      font-size: 10px;
      color: var(--ink-faint);
      letter-spacing: .12em;
      text-transform: uppercase
    }

    #sw {
      flex: 1;
      max-width: 340px;
      position: relative;
      margin: 0 auto
    }

    #s {
      width: 100%;
      padding: 8px 14px 8px 36px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--cream);
      font-family: 'Lato', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color .2s
    }

    #s::placeholder {
      color: var(--ink-faint)
    }

    #s:focus {
      border-color: var(--gold)
    }

    #si {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ink-faint);
      font-size: 14px;
      pointer-events: none
    }

    #sr {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      display: none;
      z-index: 200
    }

    #sr.open {
      display: block
    }

    .sri {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      transition: background .15s
    }

    .sri:last-child {
      border-bottom: none
    }

    .sri:hover {
      background: var(--gold-dim)
    }

    .sri strong {
      color: var(--gold-lt)
    }

    #tba {
      display: flex;
      gap: 8px;
      flex-shrink: 0
    }

    .tbb {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .05em;
      cursor: pointer;
      border: 1px solid;
      transition: all .2s;
      text-transform: uppercase;
      background: transparent;
      border-color: var(--border);
      color: var(--ink-faint)
    }

    .tbb:hover {
      border-color: var(--gold);
      color: var(--gold)
    }

    /* MOBILE MENU */
    #mbtn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--ink-faint);
      font-size: 20px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all .2s;
      line-height: 1
    }

    #mbtn:hover,
    #mbtn.open {
      border-color: var(--gold);
      color: var(--gold)
    }

    #mdd {
      position: fixed;
      top: 60px;
      right: 12px;
      z-index: 300;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--sh2);
      min-width: 180px;
      overflow: hidden;
      display: none;
      flex-direction: column;
      animation: mi .15s ease
    }

    #mdd.open {
      display: flex
    }

    .mdi {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 18px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .04em;
      color: var(--ink-faint);
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      transition: background .15s;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border)
    }

    .mdi:last-child {
      border-bottom: none
    }

    .mdi:hover {
      background: var(--gold-dim);
      color: var(--gold)
    }

    .mdi-icon {
      font-size: 16px
    }

    @media(max-width:600px) {
      #tba {
        display: none
      }

      #sw {
        display: none
      }

      #mbtn {
        display: flex
      }

      #mdd {
        width: calc(100% - 24px);
        right: 12px;
        left: 12px;
      }

      #mdd .msw {
        display: block;
        padding: 12px 18px;
        border-bottom: 1px solid var(--border);
      }

      #mdd .msw #s2 {
        width: 100%;
        padding: 10px 14px 10px 38px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--cream);
        font-family: 'Lato', sans-serif;
        font-size: 14px;
        outline: none;
      }

      #mdd .msw #s2:focus {
        border-color: var(--gold);
      }

      #mdd .msw-wrap {
        position: relative;
      }

      #mdd .msw-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--ink-faint);
        font-size: 16px;
        pointer-events: none;
      }

      #logo #ls {
        display: none
      }

      #lt {
        font-size: 17px
      }

      #tb {
        justify-content: space-between;
      }
    }

    /* CANVAS */
    #cw {
      position: fixed;
      inset: 56px 0 0 0;
      overflow: hidden;
      cursor: grab;
      background-color: var(--bg);
      background-image: radial-gradient(ellipse at 20% 30%, rgba(200, 150, 62, .06) 0%, transparent 60%), radial-gradient(ellipse at 80% 70%, rgba(100, 80, 30, .08) 0%, transparent 60%)
    }

    #cw.pan {
      cursor: grabbing
    }

    #svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible
    }

    .cp {
      fill: none;
      stroke: #8a7040;
      stroke-width: 2;
      stroke-opacity: .6
    }

    .cp.hl {
      stroke: var(--gold);
      stroke-opacity: .95;
      stroke-width: 2.5
    }

    .sp {
      fill: none;
      stroke: var(--teal);
      stroke-width: 2;
      stroke-dasharray: 6, 4;
      stroke-opacity: .75
    }

    .sp.hl {
      stroke: var(--teal);
      stroke-opacity: 1;
      stroke-width: 2.5
    }

    .sb {
      fill: none;
      stroke: #8a60c0;
      stroke-width: 1.5;
      stroke-dasharray: 3, 5;
      stroke-opacity: .65
    }

    .sb.hl {
      stroke: #a87de0;
      stroke-opacity: 1;
      stroke-width: 2
    }

    #nw {
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      transform-origin: 0 0
    }

    /* NODES */
    .no {
      position: absolute;
      width: var(--cw);
      transform: translate(-50%, -50%);
      user-select: none
    }

    .ar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 4px
    }

    .ab {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px dashed var(--gold);
      background: rgba(200, 150, 62, .12);
      color: var(--gold);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      opacity: 0;
      pointer-events: none
    }

    .ab:hover {
      background: var(--gold);
      color: #1a1200;
      border-style: solid;
      transform: scale(1.12)
    }

    .asib {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px dashed #8a60c0;
      background: rgba(138, 96, 192, .12);
      color: #8a60c0;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      opacity: 0;
      pointer-events: none
    }

    .asib:hover {
      background: #8a60c0;
      color: #fff;
      border-style: solid;
      transform: scale(1.12)
    }

    .as {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px dashed var(--teal);
      background: rgba(22, 160, 133, .12);
      color: var(--teal);
      font-size: 13px;
      cursor: pointer;
      transition: all .2s;
      opacity: 0;
      pointer-events: none
    }

    .as:hover {
      background: var(--teal);
      color: #fff;
      border-style: solid;
      transform: scale(1.12)
    }

    .abc {
      margin-top: 4px
    }

    .no.sel .ab,
    .no:hover .ab,
    .no.sel .as,
    .no:hover .as,
    .no.sel .asib,
    .no:hover .asib {
      opacity: 1;
      pointer-events: all
    }

    .nc {
      width: var(--cw);
      height: var(--ch);
      background: var(--paper);
      border-radius: var(--r);
      box-shadow: var(--sh);
      border: 1.5px solid #ddd5c0;
      padding: 12px;
      position: relative;
      cursor: pointer;
      transition: box-shadow .2s, border-color .2s;
      overflow: hidden
    }

    .nc::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--gold-lt));
      border-radius: var(--r) var(--r) 0 0;
      opacity: 0;
      transition: opacity .2s
    }

    .no.sel .nc,
    .nc:hover {
      box-shadow: var(--sh2);
      border-color: var(--gold)
    }

    .no.sel .nc::before,
    .nc:hover::before {
      opacity: 1
    }

    .nc.rc {
      border-color: var(--gold);
      background: #fffbf0
    }

    .nc.rc::before {
      opacity: 1
    }

    .nc.dm {
      opacity: .3
    }

    .nc.sc {
      border-color: rgba(22, 160, 133, .5)
    }

    .nc.sc::before {
      background: linear-gradient(90deg, var(--teal), #1abc9c);
      opacity: 1
    }

    .av {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 15px;
      font-weight: 700;
      color: #fff
    }

    .av.m {
      background: linear-gradient(135deg, #4a7fb5, #2c5f8a)
    }

    .av.f {
      background: linear-gradient(135deg, #c0607a, #8a3050)
    }

    .av.u {
      background: linear-gradient(135deg, #7a7060, #554c3a)
    }

    .nb {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--gold-dim);
      color: var(--gold);
      border: 1px solid rgba(200, 150, 62, .3);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 6px;
      max-width: 130px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .nn {
      font-family: 'Playfair Display', serif;
      font-size: 13.5px;
      font-weight: 600;
      color: var(--ink);
      line-height: 1.25;
      max-width: 130px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-bottom: 2px
    }

    .nk {
      font-size: 11px;
      color: var(--ink-soft);
      font-style: italic;
      margin-bottom: 4px
    }

    .nd {
      font-size: 10.5px;
      color: var(--ink-faint);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 130px
    }

    .na {
      position: absolute;
      bottom: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity .2s
    }

    .nc:hover .na,
    .no.sel .na {
      opacity: 1
    }

    .nab {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: all .15s
    }

    .ned {
      background: rgba(200, 150, 62, .15);
      color: var(--gold)
    }

    .ned:hover {
      background: var(--gold);
      color: #1a1200
    }

    .ndl {
      background: rgba(192, 57, 43, .12);
      color: var(--red)
    }

    .ndl:hover {
      background: var(--red);
      color: #fff
    }

    .dt {
      position: absolute;
      left: 50%;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gold);
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity .2s;
      pointer-events: none
    }

    .dtt {
      top: -4px
    }

    .dtb {
      bottom: -4px
    }

    .nc:hover .dt,
    .no.sel .dt {
      opacity: 1
    }

    /* CONTROLS - bottom LEFT (FIX #1, #3) */
    #cc {
      position: fixed;
      bottom: 24px;
      left: 24px;
      z-index: 90;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start
    }

    #rv {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--cream);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--sh);
      transition: all .2s;
      letter-spacing: .02em
    }

    #rv:hover {
      border-color: var(--gold);
      color: var(--gold)
    }

    #zc {
      display: flex;
      gap: 6px
    }

    .zb {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--ink-faint);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      font-weight: 300;
      box-shadow: var(--sh)
    }

    .zb:hover {
      border-color: var(--gold);
      color: var(--gold)
    }

    /* MODAL */
    #mo {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, .65);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #mo.open {
      display: flex
    }

    #md {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 460px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .2s ease
    }

    @keyframes mi {
      from {
        opacity: 0;
        transform: translateY(16px) scale(.97)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    #mh {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    #mt {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      color: var(--gold)
    }

    #mc {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      transition: color .15s
    }

    #mc:hover {
      color: var(--cream)
    }

    #mb {
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      max-height: 60vh;
      overflow-y: auto
    }

    #mb .full {
      grid-column: 1/-1
    }

    .fl label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--ink-faint);
      margin-bottom: 6px
    }

    .fl input,
    .fl select,
    .fl textarea {
      width: 100%;
      padding: 9px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--cream);
      font-family: 'Lato', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color .2s
    }

    .fl input:focus,
    .fl select:focus,
    .fl textarea:focus {
      border-color: var(--gold)
    }

    .fl select option {
      background: var(--bg)
    }

    .fl textarea {
      resize: vertical;
      min-height: 60px
    }

    #mf {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end
    }

    .mb {
      padding: 9px 22px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid;
      transition: all .2s
    }

    .mbc {
      background: transparent;
      border-color: var(--border);
      color: var(--ink-faint)
    }

    .mbc:hover {
      border-color: var(--cream);
      color: var(--cream)
    }

    .mbs {
      background: var(--gold);
      border-color: var(--gold);
      color: #1a1200
    }

    .mbs:hover {
      background: var(--gold-lt)
    }

    /* CONFIRM DIALOG (FIX #2) */
    #co {
      position: fixed;
      inset: 0;
      z-index: 300;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #co.open {
      display: flex
    }

    #cb {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      width: 380px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .18s ease;
      padding: 28px 28px 22px;
      text-align: center
    }

    #ci {
      font-size: 36px;
      margin-bottom: 12px
    }

    #ctit {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--cream);
      margin-bottom: 8px
    }

    #cmsg {
      font-size: 13px;
      color: var(--ink-faint);
      line-height: 1.5;
      margin-bottom: 24px
    }

    #cact {
      display: flex;
      gap: 10px;
      justify-content: center
    }

    #cno {
      padding: 9px 22px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--ink-faint);
      transition: all .2s
    }

    #cno:hover {
      border-color: var(--cream);
      color: var(--cream)
    }

    #cyes {
      padding: 9px 22px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid var(--red);
      background: rgba(192, 57, 43, .15);
      color: var(--red);
      transition: all .2s
    }

    #cyes:hover {
      background: var(--red);
      color: #fff
    }

    /* PANEL (FIX #3: z-index 95 > controls 90) */
    #pn {
      position: fixed;
      top: 56px;
      right: 0;
      bottom: 0;
      width: 300px;
      z-index: 95;
      background: var(--surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform .28s cubic-bezier(.4, 0, .2, 1);
      overflow-y: auto;
      display: flex;
      flex-direction: column
    }

    #pn.open {
      transform: none
    }

    #ph {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px
    }

    #pa {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: #fff
    }

    #pa.m {
      background: linear-gradient(135deg, #4a7fb5, #2c5f8a)
    }

    #pa.f {
      background: linear-gradient(135deg, #c0607a, #8a3050)
    }

    #pa.u {
      background: linear-gradient(135deg, #7a7060, #554c3a)
    }

    #ptit {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--cream);
      margin-bottom: 4px
    }

    #pnk {
      font-size: 13px;
      color: var(--ink-faint);
      font-style: italic;
      margin-bottom: 6px
    }

    #pbg {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 10px;
      background: var(--gold-dim);
      color: var(--gold);
      border: 1px solid rgba(200, 150, 62, .3);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase
    }

    #pc {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      flex-shrink: 0;
      transition: color .15s
    }

    #pc:hover {
      color: var(--cream)
    }

    #pb {
      padding: 20px;
      flex: 1
    }

    .pr {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: flex-start
    }

    .pri {
      font-size: 16px;
      margin-top: 1px;
      flex-shrink: 0
    }

    .prl {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--ink-faint);
      margin-bottom: 2px
    }

    .prv {
      font-size: 13px;
      color: var(--cream);
      word-break: break-word
    }

    .pre {
      color: var(--ink-faint);
      font-style: italic
    }

    #pac {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px
    }

    .pab {
      flex: 1;
      padding: 9px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid;
      text-align: center;
      transition: all .2s;
      letter-spacing: .04em
    }

    .pae {
      background: var(--gold-dim);
      border-color: rgba(200, 150, 62, .3);
      color: var(--gold)
    }

    .pae:hover {
      background: var(--gold);
      color: #1a1200;
      border-color: var(--gold)
    }

    .pad {
      background: rgba(192, 57, 43, .1);
      border-color: rgba(192, 57, 43, .25);
      color: var(--red)
    }

    .pad:hover {
      background: var(--red);
      color: #fff;
      border-color: var(--red)
    }

    /* TOAST */
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      z-index: 400;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 13px;
      color: var(--cream);
      opacity: 0;
      transition: all .3s;
      pointer-events: none;
      white-space: nowrap
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0)
    }

    /* WELCOME MODAL */
    #wm {
      position: fixed;
      inset: 0;
      z-index: 500;
      background: rgba(0, 0, 0, .75);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #wm.open {
      display: flex
    }

    #wb {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 480px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .25s ease;
      overflow: hidden
    }

    #wt {
      padding: 28px 28px 0;
      text-align: center
    }

    #wi {
      font-size: 40px;
      margin-bottom: 12px
    }

    #wtt {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 6px
    }

    #ws {
      font-size: 13px;
      color: var(--ink-faint);
      line-height: 1.6
    }

    #wg {
      padding: 20px 28px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 4px
    }

    .wgi {
      background: rgba(200, 150, 62, .07);
      border: 1px solid rgba(200, 150, 62, .18);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      gap: 10px;
      align-items: flex-start
    }

    .wgic {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 1px
    }

    .wgit {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 3px
    }

    .wgid {
      font-size: 12px;
      color: var(--ink-faint);
      line-height: 1.45
    }

    #wf {
      padding: 20px 28px 24px;
      text-align: center;
      border-top: 1px solid var(--border)
    }

    #wok {
      padding: 11px 36px;
      border-radius: 10px;
      background: var(--gold);
      border: none;
      color: #1a1200;
      font-family: 'Lato', sans-serif;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      letter-spacing: .04em
    }

    #wok:hover {
      background: var(--gold-lt);
      transform: translateY(-1px)
    }

    /* LINK EXISTING PICKER */
    #lx {
      position: fixed;
      inset: 0;
      z-index: 250;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center
    }

    #lx.open {
      display: flex
    }

    #lxb {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 420px;
      max-width: calc(100vw - 32px);
      box-shadow: var(--sh2);
      animation: mi .2s ease;
      overflow: hidden
    }

    #lxh {
      padding: 18px 22px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    #lxt {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--gold)
    }

    #lxc {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
      transition: color .15s
    }

    #lxc:hover {
      color: var(--cream)
    }

    #lxs {
      padding: 12px 22px;
      border-bottom: 1px solid var(--border)
    }

    #lxsi {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--cream);
      font-family: 'Lato', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color .2s
    }

    #lxsi:focus {
      border-color: var(--gold)
    }

    #lxl {
      max-height: 280px;
      overflow-y: auto
    }

    .lxi {
      padding: 10px 22px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background .15s;
      display: flex;
      align-items: center;
      gap: 12px
    }

    .lxi:last-child {
      border-bottom: none
    }

    .lxi:hover {
      background: var(--gold-dim)
    }

    .lxiav {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0
    }

    .lxin {
      font-size: 13px;
      color: var(--cream)
    }

    .lxis {
      font-size: 11px;
      color: var(--ink-faint)
    }

    #lxne {
      padding: 14px 22px;
      border-top: 1px solid var(--border);
      text-align: center
    }

    .lxneb {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 18px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      background: var(--gold-dim);
      color: var(--gold);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      letter-spacing: .04em
    }

    .lxneb:hover {
      background: var(--gold);
      color: #1a1200
    }

    /* LEGEND purple for siblings */
    .lr-sib {
      color: #8a60c0
    }

    #leg {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 89;
      background: rgba(26, 24, 18, .92);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 11px;
      color: var(--ink-faint);
      line-height: 2
    }

    .lr {
      display: flex;
      align-items: center;
      gap: 8px
    }

    ::-webkit-scrollbar {
      width: 6px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px
    }

    /* ── MODE SWITCHER ── */
    #modeBar {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      z-index: 99;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      background: rgba(13, 12, 8, .96);
      border-bottom: 1px solid var(--border);
      height: 44px;
    }

    .modeTab {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 0 28px;
      height: 100%;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .07em;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--ink-faint);
      border: none;
      background: transparent;
      border-bottom: 2px solid transparent;
      transition: color .2s, border-color .2s;
    }

    .modeTab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }

    .modeTab:hover:not(.active) {
      color: var(--cream);
    }

    /* adjust existing canvas top offset for mode bar */
    #cw {
      top: 100px;
    }

    #cc {
      bottom: 18px;
    }

    #leg {
      bottom: 18px;
    }

    /* ── CIRCLES CANVAS ── */
    #circlesCanvas {
      display: none;
      position: fixed;
      inset: 100px 0 0 0;
      overflow: hidden;
      background: radial-gradient(ellipse at 50% 40%, rgba(74, 127, 181, .08) 0%, transparent 65%),
        radial-gradient(ellipse at 20% 80%, rgba(200, 150, 62, .05) 0%, transparent 60%),
        var(--bg);
      cursor: grab;
    }

    #circlesCanvas.pan {
      cursor: grabbing;
    }

    #circlesCanvas.active {
      display: block;
    }

    #circlesSvg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
    }

    #circlesWorld {
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      transform-origin: 0 0;
    }

    /* USER NODE */
    .c-user {
      position: absolute;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(135deg, #c8963e, #e8b85a);
      border: 3px solid var(--gold-lt);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #1a1200;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 11px;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 32px rgba(200, 150, 62, .4), 0 4px 16px rgba(0, 0, 0, .4);
      cursor: default;
      user-select: none;
      z-index: 5;
    }

    .c-user-emoji {
      font-size: 24px;
      line-height: 1;
    }

    .c-user-label {
      font-size: 9px;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* GROUP BUBBLE (Level 2) */
    .c-group {
      position: absolute;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 2px solid;
      cursor: pointer;
      user-select: none;
      transition: transform .2s, box-shadow .2s;
      z-index: 4;
    }

    .c-group:hover {
      transform: translate(-50%, -50%) scale(1.08);
    }

    .c-group.expanded {
      border-style: solid;
    }

    .c-group-emoji {
      font-size: 26px;
      line-height: 1;
    }

    .c-group-name {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
      margin-top: 4px;
      text-align: center;
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 4px;
    }

    .c-group-count {
      font-size: 8px;
      font-weight: 700;
      padding: 1px 5px;
      border-radius: 8px;
      margin-top: 2px;
    }

    /* SUB-GROUP BUBBLE (Level 3) */
    .c-subgroup {
      position: absolute;
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      width: 68px;
      height: 68px;
      border-radius: 50%;
      border: 1.5px solid rgba(200, 150, 62, .4);
      background: rgba(26, 24, 18, .92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: transform .32s cubic-bezier(.34, 1.56, .64, 1), opacity .28s ease, box-shadow .2s;
      z-index: 3;
      backdrop-filter: blur(8px);
    }

    .c-subgroup.visible {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .c-subgroup:hover {
      border-color: var(--gold);
      box-shadow: 0 0 14px rgba(200, 150, 62, .25);
    }

    .c-subgroup-label {
      font-size: 8.5px;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
      color: var(--cream);
      text-align: center;
      padding: 0 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 60px;
    }

    .c-subgroup-count {
      font-size: 8px;
      color: var(--gold);
      margin-top: 2px;
    }

    /* SVG connector lines for circles canvas */
    .c-line {
      stroke: rgba(200, 150, 62, .25);
      stroke-width: 1.5;
      fill: none;
    }

    .c-line-sub {
      stroke: rgba(200, 150, 62, .15);
      stroke-width: 1;
      fill: none;
      stroke-dasharray: 4, 4;
    }

    /* ADD GROUP BUTTON */
    #addGroupBtn {
      position: fixed;
      bottom: 80px;
      right: 24px;
      z-index: 92;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--gold);
      color: #1a1200;
      font-size: 26px;
      font-weight: 300;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(200, 150, 62, .45);
      display: none;
      align-items: center;
      justify-content: center;
      transition: transform .2s, box-shadow .2s;
    }

    #addGroupBtn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 28px rgba(200, 150, 62, .6);
    }

    #addGroupBtn.active {
      display: flex;
    }

    /* ── GROUP CONTEXT MENU ── */
    #groupCtxMenu {
      position: fixed;
      z-index: 500;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--sh2);
      min-width: 160px;
      overflow: hidden;
      display: none;
    }

    #groupCtxMenu.open {
      display: block;
    }

    .ctx-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 16px;
      font-size: 13px;
      font-weight: 700;
      color: var(--ink-faint);
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      transition: background .15s;
      border-bottom: 1px solid var(--border);
    }

    .ctx-item:last-child {
      border-bottom: none;
    }

    .ctx-item:hover {
      background: var(--gold-dim);
      color: var(--gold);
    }

    .ctx-item.danger:hover {
      background: rgba(192, 57, 43, .12);
      color: var(--red);
    }

    /* ── CREATE / EDIT GROUP MODAL ── */
    #groupMo {
      position: fixed;
      inset: 0;
      z-index: 400;
      background: rgba(0, 0, 0, .65);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
    }

    #groupMo.open {
      display: flex;
    }

    #groupMd {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: var(--sh2);
      width: min(480px, 94vw);
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
    }

    #groupMh {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 0;
      margin-bottom: 16px;
    }

    #groupMh span {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--cream);
    }

    #groupMh button {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
    }

    #groupMb {
      padding: 0 24px 8px;
    }

    #groupMf {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 16px 24px 20px;
    }

    /* group type grid */
    .gtype-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 4px;
    }

    .gtype-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 4px;
      border-radius: 10px;
      border: 1.5px solid var(--border);
      background: transparent;
      color: var(--ink-faint);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .04em;
      cursor: pointer;
      transition: all .2s;
    }

    .gtype-btn .gt-emoji {
      font-size: 20px;
    }

    .gtype-btn.sel,
    .gtype-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: var(--gold-dim);
    }

    /* color palette */
    .gcolor-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gcolor-swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform .15s, border-color .15s;
    }

    .gcolor-swatch.sel,
    .gcolor-swatch:hover {
      transform: scale(1.2);
      border-color: var(--cream);
    }

    /* sub-group tags inside the group modal */
    .gsg-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .gsg-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 20px;
      background: var(--gold-dim);
      border: 1px solid rgba(200, 150, 62, .3);
      color: var(--gold);
      font-size: 12px;
      font-weight: 700;
    }

    .gsg-tag-del {
      background: none;
      border: none;
      color: var(--gold);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      opacity: .7;
    }

    .gsg-tag-del:hover {
      opacity: 1;
    }

    #gsgInput {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--cream);
      font-size: 12px;
      outline: none;
      width: 140px;
      transition: border-color .2s;
    }

    #gsgInput:focus {
      border-color: var(--gold);
    }

    /* ── PEOPLE LIST MODAL ── */
    #peopleMo {
      position: fixed;
      inset: 0;
      z-index: 400;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    #peopleMo.open {
      display: flex;
    }

    #peopleMd {
      background: var(--surface);
      border-radius: 20px 20px 0 0;
      box-shadow: var(--sh2);
      width: min(600px, 100vw);
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      border-bottom: none;
    }

    #peopleMh {
      padding: 18px 22px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #peopleMh .pm-title {
      flex: 1;
      min-width: 0;
    }

    #peopleMh .pm-grp {
      font-size: 11px;
      color: var(--gold);
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    #peopleMh .pm-sub {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--cream);
    }

    #peopleMh button {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 22px;
      cursor: pointer;
      flex-shrink: 0;
    }

    #peopleMbody {
      flex: 1;
      overflow-y: auto;
      padding: 12px 0;
    }

    #peopleMfoot {
      padding: 14px 22px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    /* person row in people list */
    .ppl-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 22px;
      transition: background .15s;
      cursor: default;
    }

    .ppl-row:hover {
      background: rgba(200, 150, 62, .06);
    }

    .ppl-av {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 15px;
      color: #fff;
      flex-shrink: 0;
      border: 2px solid transparent;
    }

    .ppl-av.str-close {
      border-color: var(--gold);
      box-shadow: 0 0 8px rgba(200, 150, 62, .3);
    }

    .ppl-av.str-lost {
      opacity: .5;
    }

    .ppl-info {
      flex: 1;
      min-width: 0;
    }

    .ppl-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--cream);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ppl-nick {
      font-size: 12px;
      color: var(--ink-faint);
      font-style: italic;
      margin-bottom: 2px;
    }

    .ppl-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
    }

    .ppl-badge.close {
      background: rgba(200, 150, 62, .15);
      color: var(--gold);
    }

    .ppl-badge.friend {
      background: rgba(22, 160, 133, .12);
      color: var(--teal);
    }

    .ppl-badge.acquaintance {
      background: rgba(138, 125, 96, .12);
      color: var(--ink-faint);
    }

    .ppl-badge.lost {
      background: rgba(192, 57, 43, .1);
      color: rgba(192, 57, 43, .7);
    }

    .ppl-badge.family {
      background: rgba(138, 96, 192, .12);
      color: #8a60c0;
    }

    .ppl-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .ppl-act {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s;
    }

    .ppl-act.edit {
      background: rgba(200, 150, 62, .12);
      color: var(--gold);
    }

    .ppl-act.edit:hover {
      background: var(--gold);
      color: #1a1200;
    }

    .ppl-act.del {
      background: rgba(192, 57, 43, .1);
      color: var(--red);
    }

    .ppl-act.del:hover {
      background: var(--red);
      color: #fff;
    }

    .ppl-empty {
      padding: 40px 22px;
      text-align: center;
      color: var(--ink-faint);
      font-size: 13px;
    }

    /* Add/Edit person in circles — inline form inside people modal */
    #circlePersonForm {
      display: none;
      background: var(--bg);
      border-top: 1px solid var(--border);
      padding: 18px 22px;
    }

    #circlePersonForm.open {
      display: block;
    }

    #circlePersonForm .cpf-title {
      font-family: 'Playfair Display', serif;
      font-size: 15px;
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 14px;
    }

    .str-radio-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .str-radio {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      color: var(--ink-faint);
      transition: all .2s;
      user-select: none;
    }

    .str-radio input {
      display: none;
    }

    .str-radio.sel,
    .str-radio:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: var(--gold-dim);
    }

    /* link-from-family search */
    #linkFamSearch {
      display: none;
      border-top: 1px solid var(--border);
      padding: 14px 22px;
    }

    #linkFamSearch.open {
      display: block;
    }

    #linkFamSearch input {
      width: 100%;
      padding: 9px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--cream);
      font-size: 13px;
      outline: none;
      transition: border-color .2s;
    }

    #linkFamSearch input:focus {
      border-color: var(--gold);
    }

    #linkFamResults {
      margin-top: 8px;
    }

    .lfr-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background .15s;
    }

    .lfr-item:hover {
      background: var(--gold-dim);
    }

    .lfr-av {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 13px;
      color: #fff;
      flex-shrink: 0;
    }

    .lfr-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--cream);
    }

    .lfr-sub {
      font-size: 11px;
      color: var(--ink-faint);
    }

    /* Circles zoom controls (reuse existing .zb) */
    #circlesCC {
      position: fixed;
      bottom: 18px;
      left: 24px;
      z-index: 90;
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    #circlesCC.active {
      display: flex;
    }

    /* responsive */
    @media(max-width:600px) {
      .modeTab {
        padding: 0 16px;
        font-size: 11px;
      }

      .gtype-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      #peopleMd {
        max-height: 92vh;
        border-radius: 16px 16px 0 0;
      }
    }
  